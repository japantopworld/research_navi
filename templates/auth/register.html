@auth_bp.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        data = {
            'ID': request.form['user_id'],
            'PASS': request.form['password'],
            'USERNAME': request.form.get('username', ''),
            'FURIGANA': request.form.get('furigana', ''),
            'BIRTHDAY': request.form.get('birthday', ''),
            'AGE': request.form.get('age', ''),
            'PHONE': request.form.get('phone', ''),
            'MOBILE': request.form.get('mobile', ''),
            'EMAIL': request.form.get('email', ''),
            'DEPARTMENT': request.form.get('department', ''),
            'REFERRER': request.form.get('referrer', '')
        }

        # 重複チェック
        if os.path.exists(USERS_CSV_PATH):
            with open(USERS_CSV_PATH, newline='', encoding='utf-8') as csvfile:
                reader = csv.DictReader(csvfile)
                for row in reader:
                    if row['ID'] == data['ID']:
                        return render_template('auth/register.html', error='このIDは既に登録されています')

        # 新規登録
        with open(USERS_CSV_PATH, 'a', newline='', encoding='utf-8') as csvfile:
            fieldnames = list(data.keys())
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            if csvfile.tell() == 0:
                writer.writeheader()
            writer.writerow(data)

        return redirect(url_for('auth_bp.login'))

    return render_template('auth/register.html')

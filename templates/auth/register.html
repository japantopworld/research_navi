from flask import Blueprint, render_template, request, redirect, url_for, flash, session
import csv
import os
from datetime import datetime

register_bp = Blueprint("register_bp", __name__)

USERS_CSV = "data/users.csv"
DEPARTMENTS = {
    "KIN": "鳳陽管理職（その他）",
    "BYR": "バイヤー",
    "KEI": "経理",
    "HAN": "販売員",
    "BUT": "物流",
    "GOT": "合統括"
}

def generate_login_id(department_code, birthday_str, intro_code_alpha):
    try:
        # 誕生日（月日4桁）を取り出し
        birthday = datetime.strptime(birthday_str, "%Y/%m/%d")
        mmdd = birthday.strftime("%m%d")
    except:
        return None  # 不正な日付ならID生成しない

    # 英字紹介コードがないと生成不可
    if intro_code_alpha not in ["A", "B", "C", "D", "E"]:
        return None

    # CSV から既存ユーザーを読み取り
    if not os.path.exists(USERS_CSV):
        existing = []
    else:
        with open(USERS_CSV, "r", encoding="utf-8") as f:
            existing = list(csv.DictReader(f))

    # 同じ条件（部署・紹介コード・誕生日・末尾英字）で連番を付ける
    base = f"{department_code}{intro_code_alpha}{mmdd}"
    suffix_letter = intro_code_alpha  # A〜E
    similar_ids = [u["ID"] for u in existing if u["ID"].startswith(f"{base}{suffix_letter}")]
    serial = len(similar_ids) + 1

    return f"{base}{suffix_letter}{serial}"

@register_bp.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        username = request.form.get("username")
        kana = request.form.get("kana")
        birthday = request.form.get("birthday")
        email = request.form.get("email")
        department = request.form.get("department")
        intro_code_alpha = request.form.get("intro_code")

        password = request.form.get("password")

        # 部署略称を取得
        department_code = next((code for code, name in DEPARTMENTS.items() if name == department), "KIN")

        login_id = generate_login_id(department_code, birthday, intro_code_alpha)

        if not login_id:
            flash("登録情報に誤りがあります。", "danger")
            return redirect(url_for("register_bp.register"))

        # 保存
        file_exists = os.path.exists(USERS_CSV)
        with open(USERS_CSV, "a", encoding="utf-8", newline="") as f:
            writer = csv.writer(f)
            if not file_exists:
                writer.writerow(["ユーザー名", "ふりがな", "生年月日", "年齢", "メールアドレス", "部署", "紹介者NO", "ID", "PASS"])
            age = datetime.today().year - datetime.strptime(birthday, "%Y/%m/%d").year
            writer.writerow([username, kana, birthday, age, email, department, intro_code_alpha, login_id, password])

        flash(f"登録が完了しました。あなたのログインIDは {login_id} です。", "success")
        return redirect(url_for("login_bp.login"))

    return render_template("auth/register.html", departments=DEPARTMENTS.values(), intro_codes=["A", "B", "C", "D", "E"])

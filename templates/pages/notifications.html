{% extends "base/layout.html" %}
{% block title %}通知一覧 | リサーチナビ{% endblock %}
{% block content %}

<h1>📣 通知一覧</h1>

<div class="actions">
  <button onclick="markAllRead()" class="ghost">すべて既読にする</button>
  <a href="{{ url_for('setting') }}" class="btn">⚙️ 設定を開く</a>
</div>

{% if rows|length == 0 %}
  <p class="muted">通知はまだありません。</p>
{% else %}
  <div class="list">
    {% for n in rows %}
      <article class="item {% if n.unread %}unread{% endif %}">
        <header>
          <span class="badge {{ n.kind }}">{{ n.kind|upper }}</span>
          <h3>{{ n.title }}</h3>
          <time>{{ n.created_at|fmt }}</time>
        </header>
        {% if n.body %}
          <p class="body">{{ n.body }}</p>
        {% endif %}

        {% set meta = n.meta %}
        {% if meta and meta|length > 0 %}
          <table class="meta">
            <tbody>
              {% for k,v in meta.items() %}
              <tr><th>{{ k }}</th><td>{{ v }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        <footer>
          <button onclick="markRead({{ n.id }}, this)">既読にする</button>
          <button class="ghost" onclick="snooze({{ n.id }}, 60, this)">1時間後に再通知</button>
        </footer>
      </article>
    {% endfor %}
  </div>
{% endif %}

<style>
.actions{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap}
.actions .btn,.actions .ghost{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111;text-decoration:none}
.actions button{padding:8px 12px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
.actions .ghost{background:#fff;color:#111;border-color:#e5e7eb}
.list{display:flex;flex-direction:column;gap:12px}
.item{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px}
.item.unread{box-shadow:0 2px 10px rgba(0,0,0,.05)}
.item header{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
.item h3{margin:0;font-size:16px}
.item time{color:#6b7280;font-size:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff}
.badge.info{background:#64748b}
.badge.warn{background:#d97706}
.badge.profit{background:#16a34a}
.item .body{margin:.5rem 0}
.meta{width:100%;border-collapse:collapse;margin:.25rem 0 .5rem}
.meta th,.meta td{border:1px solid #e5e7eb;padding:6px 8px;font-size:14px}
.meta th{background:#f8fafc;color:#374151;text-align:left;width:120px}
.item footer{display:flex;gap:8px;flex-wrap:wrap}
.item footer .ghost{background:#fff;color:#111;border:1px solid #e5e7eb}
</style>

<script>
async function markRead(id, btn){
  try{
    const r = await fetch('/api/notifications/mark_read', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids:[id] })
    });
    const j = await r.json();
    if(j.ok){
      const art = btn.closest('.item');
      art && art.classList.remove('unread');
    }
  }catch(e){ console.log(e); }
}

async function markAllRead(){
  const ids = Array.from(document.querySelectorAll('.item.unread'))
    .map(x => Number(x.querySelector('button').getAttribute('onclick').match(/\d+/)[0]))
    .filter(Boolean);
  if(ids.length === 0) return;
  try{
    const r = await fetch('/api/notifications/mark_read', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    });
    const j = await r.json();
    if(j.ok){
      document.querySelectorAll('.item.unread').forEach(x=>x.classList.remove('unread'));
    }
  }catch(e){ console.log(e); }
}

async function snooze(id, minutes, btn){
  try{
    const r = await fetch('/api/notifications/snooze', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id, minutes })
    });
    const j = await r.json();
    if(j.ok){
      const art = btn.closest('.item');
      art && (art.style.opacity = .5);
    }
  }catch(e){ console.log(e); }
}
</script>

{% endblock %}

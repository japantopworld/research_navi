{% extends "base/layout.html" %}
{% block title %}📥 メールボックス{% endblock %}
{% block content %}

<h2 style="text-align:center;">📬 {{ user_id }} さんのメールボックス</h2>

<!-- タブ -->
<div class="tabs">
  <a href="{{ url_for('news', tab='inbox') }}" class="tab {% if tab=='inbox' %}active{% endif %}">
    📥 受信
    {% if unread_count > 0 %}
      <span class="badge">{{ unread_count }}</span>
    {% endif %}
  </a>
  <a href="{{ url_for('news', tab='sent') }}" class="tab {% if tab=='sent' %}active{% endif %}">📤 送信</a>
  <a href="{{ url_for('news', tab='compose') }}" class="tab {% if tab=='compose' %}active{% endif %}">✍ 新規</a>
</div>

<!-- 🔍 検索フォーム -->
{% if tab in ['inbox', 'sent'] %}
<form method="GET" style="text-align:center; margin:1rem;">
  <input type="hidden" name="tab" value="{{ tab }}">
  <input type="text" name="q" placeholder="件名・本文で検索" value="{{ request.args.get('q','') }}">
  <button type="submit">検索</button>
</form>
{% endif %}

{% if tab == 'inbox' %}
<form method="POST">
  <table class="inbox">
    <tr>
      <th></th><th>送信者</th><th>件名</th><th>日時</th><th>状態</th>
    </tr>
    {% for m in inbox %}
    <tr class="{{ 'unread' if m['ステータス']=='未読' else 'read' }}">
      <td><input type="checkbox" name="msg_ids" value="{{ m['ID'] }}"></td>
      <td>{{ m["送信者"] }}</td>
      <td><a href="{{ url_for('news_detail', msg_id=m['ID']) }}">{{ m["件名"] }}</a></td>
      <td>{{ m["送信日時"] }}</td>
      <td>{{ m["ステータス"] }}</td>
    </tr>
    {% endfor %}
  </table>
  <div class="actions">
    <button type="submit" name="action" value="mark_read">✅ 選択を既読に</button>
    <button type="submit" name="action" value="delete" onclick="return confirm('本当に削除しますか？')">🗑️ 削除</button>
  </div>
</form>
{% endif %}

{% if tab == 'sent' %}
<form method="POST">
  <table class="inbox">
    <tr><th></th><th>宛先</th><th>件名</th><th>日時</th><th>状態</th></tr>
    {% for m in sent %}
    <tr>
      <td><input type="checkbox" name="msg_ids" value="{{ m['ID'] }}"></td>
      <td>{{ m["宛先"] }}</td>
      <td><a href="{{ url_for('news_detail', msg_id=m['ID']) }}">{{ m["件名"] }}</a></td>
      <td>{{ m["送信日時"] }}</td>
      <td>{{ m["ステータス"] }}</td>
    </tr>
    {% endfor %}
  </table>
  <div class="actions">
    <button type="submit" name="action" value="delete" onclick="return confirm('本当に削除しますか？')">🗑️ 削除</button>
  </div>
</form>
{% endif %}

{% if tab == 'compose' %}
<form method="POST" enctype="multipart/form-data" class="compose-form">
  <label>宛先:</label>
  <input type="text" name="to" value="{{ reply_to or '' }}" placeholder="ID または @部署名" required>
  <label>件名:</label>
  <input type="text" name="subject" value="{{ reply_subject or '' }}" required>
  <label>本文:</label>
  <textarea name="body" rows="6" required></textarea>
  <label>添付:</label>
  <input type="file" name="attach">
  <button type="submit">📨 送信</button>
</form>
{% endif %}

<style>
  .tabs { display:flex; justify-content:center; gap:1rem; margin:1rem 0; }
  .tab { padding:.6rem 1.2rem; border-radius:.6rem; text-decoration:none; font-weight:bold; background:#f3f4f6; color:#333; position:relative; }
  .tab.active { background:#dc2626; color:#ffeb3b; }
  .badge { background:#dc2626; color:#fff; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.8rem; margin-left:0.3rem; }
  .inbox { width:90%; margin:0 auto; border-collapse:collapse; }
  .inbox th,.inbox td { border:1px solid #ddd; padding:8px; text-align:center; }
  .inbox .unread { background:#fff; color:#dc2626; font-weight:700; }
  .inbox .read { background:#f9fafb; color:#555; }
  .compose-form { width:70%; margin:1rem auto; display:flex; flex-direction:column; gap:.8rem; }
  .compose-form input,.compose-form textarea { padding:.6rem; border:1px solid #ddd; border-radius:.4rem; }
  .compose-form button { padding:.6rem; background:#dc2626; color:#ffeb3b; border:none; border-radius:.6rem; font-weight:bold; cursor:pointer; }
  .actions { text-align:center; margin:1rem; }
  .actions button { margin:0 .5rem; padding:.5rem 1rem; }
</style>

{% endblock %}

{% extends "base/layout.html" %}
{% block title %}利益ランキング | リサーチナビ{% endblock %}
{% block content %}

<h1>利益ランキング <small style="color:#6b7280;font-size:.85em">({{ label }})</small></h1>

<form method="get" class="search-card">
  <div class="grid">
    <label>
      <span>開始日</span>
      <input type="date" name="start" value="{{ params.start }}">
    </label>
    <label>
      <span>終了日</span>
      <input type="date" name="end" value="{{ params.end }}">
    </label>
    <label>
      <span>プラットフォーム</span>
      <select name="platform">
        <option value="">すべて</option>
        <option value="all" {% if params.platform=='all' %}selected{% endif %}>すべて</option>
        {% for p in platforms %}
          <option value="{{ p }}" {% if params.platform==p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      <span>キーワード（商品名）</span>
      <input type="text" name="keyword" value="{{ params.keyword }}" placeholder="例：Switch">
    </label>
    <label>
      <span>最小 合計利益（円）</span>
      <input type="number" name="min_total_profit" min="0" step="1" value="{{ params.min_total_profit or '' }}">
    </label>
  </div>
  <div class="actions">
    <button type="submit">この条件で集計</button>
    <a class="btn" href="{{ url_for('ranking') }}">条件クリア</a>
    <a class="btn" href="{{ url_for('export_ranking',
                                     start=params.start, end=params.end,
                                     platform=params.platform, keyword=params.keyword,
                                     min_total_profit=params.min_total_profit) }}">CSVエクスポート</a>
  </div>
</form>

{% if top3 and top3|length %}
<div class="top3">
  {% for r in top3 %}
  <div class="card hi">
    <div class="rank">#{{ loop.index }}</div>
    <div class="name" title="{{ r.name }}">{{ r.name }}</div>
    <div class="pf">{{ r.platform }}</div>
    <div class="sum">合計利益：<b>{{ (r.sum_profit or 0)|yen }}</b></div>
    <div class="meta">
      <span>件数 {{ r.cnt }}</span>
      <span>平均利益率 {{ (r.avg_margin or 0)|round(2) }}%</span>
    </div>
    <div class="period">{{ (r.first_at or '')|fmt }} 〜 {{ (r.last_at or '')|fmt }}</div>
    <div class="btns">
      <button class="detail" data-name="{{ r.name }}" data-platform="{{ r.platform }}">詳細</button>
      <!-- ★ ワンクリックで履歴絞り込み -->
      <a class="btn to-history"
         href="{{ url_for('history',
                start=params.start, end=params.end,
                platform=r.platform, keyword=r.name) }}">履歴で見る</a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>商品名</th>
        <th>PF</th>
        <th class="num">件数</th>
        <th class="num">売上合計</th>
        <th class="num">利益合計</th>
        <th class="num">平均利益率</th>
        <th>期間</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ loop.index + 3 }}</td>
        <td class="name" title="{{ r.name }}">{{ r.name }}</td>
        <td>{{ r.platform }}</td>
        <td class="num">{{ r.cnt }}</td>
        <td class="num">{{ (r.sum_price or 0)|yen }}</td>
        <td class="num">{{ (r.sum_profit or 0)|yen }}</td>
        <td class="num">{{ (r.avg_margin or 0)|round(2) }}%</td>
        <td>{{ (r.first_at or '')|fmt }} 〜 {{ (r.last_at or '')|fmt }}</td>
        <td class="ops">
          <button class="detail" data-name="{{ r.name }}" data-platform="{{ r.platform }}">詳細</button>
          <!-- ★ 履歴へ -->
          <a class="btn to-history"
             href="{{ url_for('history',
                    start=params.start, end=params.end,
                    platform=r.platform, keyword=r.name) }}">履歴で見る</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 詳細モーダル -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true">
    <div class="head">
      <div class="title">
        <div id="m_name" class="m-name"></div>
        <div id="m_pf" class="m-pf"></div>
      </div>
      <div class="head-actions">
        <!-- ★ モーダルからも履歴へ -->
        <a id="m_history" class="btn small" href="#" target="_blank">履歴で開く</a>
        <button id="m_close" class="close" aria-label="閉じる">×</button>
      </div>
    </div>

    <div class="summary">
      <div class="pill">件数 <b id="m_cnt">0</b></div>
      <div class="pill">売上合計 <b id="m_sum_price">¥0</b></div>
      <div class="pill">利益合計 <b id="m_sum_profit">¥0</b></div>
      <div class="pill">平均利益率 <b id="m_avg_margin">0%</b></div>
    </div>

    <div class="table-wrap small">
      <table class="table">
        <thead>
          <tr>
            <th>日時</th>
            <th class="num">販売</th>
            <th class="num">仕入</th>
            <th class="num">送料</th>
            <th class="num">手数料</th>
            <th class="num">利益</th>
            <th class="num">利益率</th>
          </tr>
        </thead>
        <tbody id="m_rows">
          <tr><td colspan="7" style="text-align:center;color:#6b7280">読み込み中…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
.search-card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;margin:10px 0 14px}
.search-card .grid{display:grid;gap:10px;grid-template-columns:repeat(1,minmax(0,1fr))}
.search-card label{display:flex;flex-direction:column;gap:6px}
.search-card label>span{font-size:12px;color:#6b7280}
.search-card input,.search-card select{padding:8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
.actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.actions .btn, .actions button{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;text-decoration:none;color:#111;cursor:pointer}
.actions button{background:#111;color:#fff;border-color:#111}

.top3{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr));margin:12px 0}
.card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;position:relative}
.card.hi{box-shadow:0 1px 6px rgba(0,0,0,.06)}
.card .rank{position:absolute;right:10px;top:8px;font-weight:700;color:#6b7280}
.card .name{font-weight:700;font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card .pf{color:#6b7280;font-size:12px}
.card .sum{margin-top:6px}
.card .meta{display:flex;gap:10px;color:#6b7280;font-size:12px}
.card .period{color:#6b7280;font-size:12px;margin-top:4px}
.card .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.card .detail{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer}
.card .detail:hover{border-color:#cbd5e1}
.card .to-history{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#f8fafc;text-decoration:none;color:#111}

.table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
.table{width:100%;border-collapse:collapse;background:#fff}
.table th,.table td{padding:10px;border-bottom:1px solid #f1f5f9;white-space:nowrap}
.table thead th{position:sticky;top:0;background:#f8fafc;font-weight:700}
.table .num{text-align:right}
.table td.name{max-width:420px;overflow:hidden;text-overflow:ellipsis}
.ops .btn,.ops .detail{padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;text-decoration:none;color:#111;cursor:pointer}
.ops .detail{background:#fff}
.ops .btn{background:#f8fafc}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-start;justify-content:center;padding:20px;z-index:1000}
.modal.show{display:flex}
.dialog{width:min(980px,96vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
.head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
.m-name{font-size:16px;font-weight:700}
.m-pf{font-size:12px;color:#6b7280}
.head-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.close{border:1px solid #e5e7eb;border-radius:8px;background:#fff;padding:6px 10px;cursor:pointer}
.btn.small{padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;text-decoration:none;color:#111}
.summary{display:flex;gap:8px;flex-wrap:wrap;padding:10px}
.pill{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff}
.table-wrap.small{margin:10px;border:1px solid #e5e7eb;border-radius:10px}
@media (max-width:980px){.top3{grid-template-columns:1fr}}
</style>

<script>
(() => {
  const $  = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const jpy = (n)=>'¥'+(Math.round(n||0)).toLocaleString();
  const pct = (x)=> (isFinite(x)? Number(x).toFixed(2) : '0.00') + '%';

  function openModal(name, pf){
    $('#m_name').textContent = name;
    $('#m_pf').textContent = pf;
    $('#m_rows').innerHTML = `<tr><td colspan="7" style="text-align:center;color:#6b7280">読み込み中…</td></tr>`;
    $('#m_cnt').textContent = '0';
    $('#m_sum_price').textContent = '¥0';
    $('#m_sum_profit').textContent = '¥0';
    $('#m_avg_margin').textContent = '0%';
    $('#modal').classList.add('show');

    // 履歴で開くリンク（現在の start/end も維持）
    const start = new URLSearchParams(location.search).get('start') || '';
    const end   = new URLSearchParams(location.search).get('end')   || '';
    const histUrl = `/history?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&platform=${encodeURIComponent(pf)}&keyword=${encodeURIComponent(name)}`;
    $('#m_history').setAttribute('href', histUrl);

    const url = `/api/ranking/details?name=${encodeURIComponent(name)}&platform=${encodeURIComponent(pf)}&limit=50`;
    fetch(url).then(r=>r.json()).then(data=>{
      const rows = data.items || [];
      if(rows.length === 0){
        $('#m_rows').innerHTML = `<tr><td colspan="7" style="text-align:center;color:#6b7280">該当データがありません</td></tr>`;
        return;
      }
      let html='', sumPrice=0, sumProfit=0;
      rows.forEach(r=>{
        sumPrice += r.price||0;
        sumProfit += r.profit||0;
        html += `
          <tr>
            <td>${r.created_at}</td>
            <td class="num">${jpy(r.price)}</td>
            <td class="num">${jpy(r.cost)}</td>
            <td class="num">${jpy(r.ship)}</td>
            <td class="num">${jpy(r.fee)}</td>
            <td class="num">${jpy(r.profit)}</td>
            <td class="num">${pct(r.margin)}</td>
          </tr>`;
      });
      $('#m_rows').innerHTML = html;
      $('#m_cnt').textContent = rows.length;
      $('#m_sum_price').textContent = jpy(sumPrice);
      $('#m_sum_profit').textContent = jpy(sumProfit);
      const avg = rows.reduce((a,b)=>a+(parseFloat(b.margin)||0),0) / rows.length;
      $('#m_avg_margin').textContent = pct(avg);
    }).catch(_=>{
      $('#m_rows').innerHTML = `<tr><td colspan="7" style="text-align:center;color:#b91c1c">読み込みに失敗しました</td></tr>`;
    });
  }

  $$('.detail').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      openModal(btn.dataset.name, btn.dataset.platform);
    });
  });
  $('#m_close').addEventListener('click', ()=> $('#modal').classList.remove('show'));
  $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') $('#modal').classList.remove('show'); });
})();
</script>

{% endblock %}

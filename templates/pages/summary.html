{% extends "base/layout.html" %}
{% block title %}æœˆæ¬¡ã‚µãƒãƒª | ãƒªã‚µãƒ¼ãƒãƒŠãƒ“{% endblock %}

{% block content %}
<section class="hero">
  <h2 class="hero-title">æœˆæ¬¡ã‚µãƒãƒª</h2>
  <p class="hero-sub">æœŸé–“å†…ã®KPIã¨å–å¼•ä¸€è¦§ã€‚ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ãã¾ã™ã€‚</p>
</section>

<!-- æœŸé–“é¸æŠ -->
<form method="get" action="{{ url_for('summary') }}" class="card" style="padding:12px;border:1px solid #e8ecf4;border-radius:14px;">
  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
    <label>é–‹å§‹æ—¥
      <input class="input" type="date" name="start" value="{{ start }}">
    </label>
    <label>çµ‚äº†æ—¥
      <input class="input" type="date" name="end" value="{{ end }}">
    </label>

    <div style="display:flex; gap:6px; align-items:center;">
      <button class="btn primary" type="submit" name="mode" value="custom">é©ç”¨</button>
      <a class="btn ghost" href="{{ url_for('summary', mode='this') }}">ä»Šæœˆ</a>
      <a class="btn ghost" href="{{ url_for('summary', mode='prev') }}">å…ˆæœˆ</a>
    </div>

    <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ -->
    <form method="post" action="{{ url_for('summary_send') }}" style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <input type="hidden" name="start" value="{{ start }}">
      <input type="hidden" name="end" value="{{ end }}">
      <button class="btn" type="submit">ğŸ“§ ã“ã®æœŸé–“ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
    </form>
  </div>
</form>

<!-- KPI -->
<section class="card" style="margin-top:12px;padding:12px;border:1px solid #e8ecf4;border-radius:14px;">
  <h3 style="margin:0 0 10px;">KPIï¼ˆ{{ start }} ã€œ {{ end }}ï¼‰</h3>
  <div class="grid grid-3">
    <div class="kpi"><div class="kpi-label">å–å¼•ä»¶æ•°</div><div class="kpi-val">{{ summary.count }}</div></div>
    <div class="kpi"><div class="kpi-label">åˆè¨ˆåˆ©ç›Š</div><div class="kpi-val">{{ summary.total_profit|yen }}</div></div>
    <div class="kpi"><div class="kpi-label">å¹³å‡åˆ©ç›Š</div><div class="kpi-val">{{ summary.avg_profit|yen }}</div></div>
    <div class="kpi"><div class="kpi-label">å¹³å‡åˆ©ç›Šç‡</div><div class="kpi-val">{{ summary.avg_margin }}%</div></div>
    <div class="kpi"><div class="kpi-label">åˆè¨ˆè²©å£²</div><div class="kpi-val">{{ summary.total_sales|yen }}</div></div>
    <div class="kpi"><div class="kpi-label">åˆè¨ˆä»•å…¥</div><div class="kpi-val">{{ summary.total_cost|yen }}</div></div>
  </div>

  <!-- ãƒŸãƒ‹ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆåˆ©ç›Šã®æ¨ç§»ï¼šæ—¥æ¬¡åˆç®—ã‚’JSã§æç”»ï¼‰ -->
  <div id="trendBox" class="card" style="margin-top:12px;padding:10px;border:1px dashed #dfe6f3;border-radius:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <strong style="font-size:14px;">åˆ©ç›Šãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆåˆç®—/æ—¥æ¬¡ï¼‰</strong>
      <small style="color:#667085">ç°¡æ˜“ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³</small>
    </div>
    <div id="trendSvg" style="height:64px;"></div>
  </div>
</section>

<!-- æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="table-like" style="margin-top:12px;">
  <table>
    <thead>
      <tr>
        <th style="width:140px;">æ—¥æ™‚</th>
        <th>å•†å“å</th>
        <th style="width:110px;">PF</th>
        <th class="td-right" style="width:110px;">ä»•å…¥</th>
        <th class="td-right" style="width:110px;">è²©å£²</th>
        <th class="td-right" style="width:90px;">é€æ–™</th>
        <th class="td-right" style="width:110px;">æ‰‹æ•°æ–™</th>
        <th class="td-right" style="width:110px;">åˆ©ç›Š</th>
        <th class="td-right" style="width:100px;">åˆ©ç›Šç‡</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      {% set p = (r['åˆ©ç›Š']|float) %}
      <tr style="{% if p>0 %}background:#f7fff9{% elif p<0 %}background:#fff7f7{% endif %}">
        <td>{{ r["æ—¥æ™‚"] }}</td>
        <td class="td-left">{{ r["å•†å“å"] }}</td>
        <td>{{ r["ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ "] }}</td>
        <td class="td-right">{{ r["ä»•å…¥ä¾¡æ ¼"]|yen }}</td>
        <td class="td-right">{{ r["è²©å£²ä¾¡æ ¼"]|yen }}</td>
        <td class="td-right">{{ r["é€æ–™"]|yen }}</td>
        <td class="td-right">{{ r["æ‰‹æ•°æ–™(å††)"]|yen }}</td>
        <td class="td-right"><strong>{{ r["åˆ©ç›Š"]|yen }}</strong></td>
        <td class="td-right">{{ r["åˆ©ç›Šç‡(%)"] }}%</td>
      </tr>
      {% endfor %}
      {% if not rows %}
      <tr><td colspan="9" style="text-align:center;color:#667085;">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
(()=>{
  // rows ã‚’æ—¥æ¬¡é›†è¨ˆã—ã¦ãƒŸãƒ‹ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆSVGï¼‰ã‚’æç”»ï¼ˆå¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸ä½¿ç”¨ï¼‰
  const rows = {{ rows|tojson }};
  if(!rows || !rows.length){ return; }

  // æ—¥ä»˜ -> åˆ©ç›Šåˆç®—
  const byDay = {};
  rows.forEach(r=>{
    const dt = (r["æ—¥æ™‚"]||"").slice(0,10);
    const p  = Number(r["åˆ©ç›Š"]||0);
    byDay[dt] = (byDay[dt]||0) + p;
  });
  const days = Object.keys(byDay).sort();
  const vals = days.map(d=>byDay[d]);

  const svgW = 600, svgH = 64, pad = 6;
  const maxV = Math.max(...vals, 1);
  const minV = Math.min(...vals, 0);
  const span = Math.max(maxV - minV, 1);

  // åº§æ¨™å¤‰æ›
  const x = i => pad + (svgW - pad*2) * (i/(days.length-1 || 1));
  const y = v => svgH - pad - (svgH - pad*2) * ((v - minV) / span);

  // æŠ˜ã‚Œç·šãƒ‘ã‚¹
  let d = "";
  vals.forEach((v,i)=>{ d += (i===0 ? "M" : "L") + x(i) + " " + y(v) + " "; });

  // åŸºæº–ãƒ©ã‚¤ãƒ³ï¼ˆ0å††ï¼‰
  const y0 = (0 >= minV && 0 <= maxV) ? y(0) : null;

  const el = document.getElementById('trendSvg');
  el.innerHTML = `
    <svg viewBox="0 0 ${svgW} ${svgH}" width="100%" height="${svgH}">
      <rect x="0" y="0" width="${svgW}" height="${svgH}" fill="#fff"/>
      ${y0!==null ? `<line x1="0" y1="${y0}" x2="${svgW}" y2="${y0}" stroke="#e8ecf4"/>` : ''}
      <path d="${d}" fill="none" stroke="#2f7bff" stroke-width="2"/>
      ${vals.map((v,i)=>`<circle cx="${x(i)}" cy="${y(v)}" r="2.5" fill="#2f7bff"/>`).join('')}
    </svg>
    <div style="display:flex;gap:10px;color:#667085;font-size:12px;margin-top:4px;">
      <span>æœŸé–“: <strong>${days[0]||'-'} ã€œ ${days[days.length-1]||'-'}</strong></span>
      <span>æœ€å¤§: <strong>Â¥${Math.max(...vals).toLocaleString('ja-JP')}</strong></span>
      <span>æœ€å°: <strong>Â¥${Math.min(...vals).toLocaleString('ja-JP')}</strong></span>
      <span>å¹³å‡: <strong>Â¥${Math.round(vals.reduce((a,b)=>a+b,0)/(vals.length||1)).toLocaleString('ja-JP')}</strong></span>
    </div>
  `;
})();
</script>
{% endblock %}

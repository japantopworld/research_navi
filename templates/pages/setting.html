{% extends "base/layout.html" %}
{% block title %}設定 | リサーチナビ{% endblock %}
{% block content %}

<h1>⚙️ 設定</h1>

<div class="card">
  <form method="post" action="{{ url_for('setting') }}">
    <div class="grid">
      <label>
        <span>メール通知を有効化</span>
        <label class="switch">
          <input type="checkbox" name="mail_enabled" {% if s.mail_enabled %}checked{% endif %}>
          <i></i><em>{{ 'ON' if s.mail_enabled else 'OFF' }}</em>
        </label>
        <small class="muted">利益が閾値を超えたとき、メールで通知します。</small>
      </label>

      <label>
        <span>メールプロバイダ（またはSMTPホスト）</span>
        <input name="mail_provider" value="{{ s.mail_provider or 'gmail' }}" placeholder="gmail / icloud / outlook / yahoo / smtp.example.com">
        <small class="muted">既定: gmail / icloud / outlook / yahoo。独自SMTPはホスト名を直接入力。</small>
      </label>

      <label>
        <span>送信元アドレス（ログインID）</span>
        <input name="mail_from" value="{{ s.mail_from }}" placeholder="example@gmail.com" required>
      </label>

      <label class="grow">
        <span>送信先アドレス（カンマ区切り）</span>
        <input name="mail_to" value="{{ s.mail_to }}" placeholder="taro@example.com, hanako@example.com">
      </label>

      <label>
        <span>アプリパスワード / SMTPパスワード</span>
        <input name="mail_pass" type="password" value="" placeholder="※未入力なら変更しません">
        <small class="muted">空欄なら既存のパスワードを保持します。</small>
      </label>

      <label>
        <span>利益の閾値（円）</span>
        <input name="profit_threshold" type="number" inputmode="numeric" value="{{ s.profit_threshold or 5000 }}" min="0" step="100">
        <small class="muted">この金額以上の利益で通知します。</small>
      </label>
    </div>

    <div class="actions">
      <button type="submit">💾 保存する</button>
      <form method="post" action="{{ url_for('setting_test_mail') }}" style="display:inline;">
        <button type="submit" class="ghost">✉️ テスト送信</button>
      </form>
      <a href="{{ url_for('notifications') }}" class="btn">📣 通知一覧へ</a>
    </div>
  </form>
</div>

<div class="card">
  <h3>ヘルプ</h3>
  <ul class="muted">
    <li>Gmailは <b>2段階認証＋アプリパスワード</b> が必要です。</li>
    <li>iCloudは「<b>App用パスワード</b>」が必要です。</li>
    <li>独自SMTPを使う場合は「プロバイダ」に <code>smtp.example.com</code> を入力してください（ポートやSSL/TLSは自動判定）。</li>
  </ul>
</div>

<style>
.card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;margin:10px 0}
.grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
.grow{grid-column:span 2}
label{display:flex;flex-direction:column;gap:6px}
label>span{font-size:12px;color:#6b7280}
input{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.actions button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
.actions .ghost{background:#fff;color:#111;border-color:#e5e7eb}
.actions .btn{padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px;text-decoration:none;color:#111;background:#fff}
.muted{color:#6b7280}
.switch{position:relative;display:inline-flex;align-items:center;gap:8px}
.switch input{display:none}
.switch i{width:46px;height:26px;border-radius:20px;position:relative;background:#e5e7eb;display:inline-block;transition:.2s}
.switch i::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.15);transition:.2s}
.switch input:checked + i{background:#111}
.switch input:checked + i::after{transform:translateX(20px)}
.switch em{font-style:normal;color:#6b7280}
@media (max-width:900px){.grid{grid-template-columns:1fr}.grow{grid-column:span 1}}
</style>

{% endblock %}

{% extends "base/layout.html" %}
{% block title %}管理ダッシュボード | リサーチナビ{% endblock %}
{% block content %}

<div class="d-flex">
  <!-- サイドバー -->
  <nav class="flex-shrink-0 p-3 bg-light border-end" style="width: 240px; min-height: 100vh;">
    <a href="/" class="d-flex align-items-center mb-3 text-dark text-decoration-none">
      <span class="fs-5 fw-bold">リサーチナビ</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a href="/" class="nav-link">🏠 ホーム</a>
      </li>
      <li>
        <a href="/dashboard" class="nav-link active">📊 ダッシュボード</a>
      </li>
      <li>
        <a href="#stock" class="nav-link">📦 在庫管理</a>
      </li>
      <li>
        <a href="#alerts" class="nav-link">⚠ アラート</a>
      </li>
    </ul>
  </nav>

  <!-- メインコンテンツ -->
  <div class="flex-grow-1 p-4" style="background-color: #f8f9fa;">
    <h2 class="mb-4">📊 ダッシュボード</h2>

    <!-- サマリー -->
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h6 class="text-muted">今日の売上</h6>
            <h4 class="fw-bold text-success">{{ today_sales | int }} 円</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h6 class="text-muted">今日の利益</h6>
            <h4 class="fw-bold text-info">{{ today_profit | int }} 円</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h6 class="text-muted">今月の売上</h6>
            <h4 class="fw-bold text-primary">{{ monthly_sales | int }} 円</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <h6 class="text-muted">今月の利益</h6>
            <h4 class="fw-bold text-warning">{{ monthly_profit | int }} 円</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- 売上グラフ -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h6 class="card-title">📈 直近7日間の売上</h6>
        <canvas id="salesChart"></canvas>
      </div>
    </div>

    <div class="row g-3">
      <!-- 在庫 -->
      <div class="col-md-6" id="stock">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">📦 在庫トップ5</h6>
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>商品</th>
                  <th>在庫数</th>
                  <th>カテゴリ</th>
                </tr>
              </thead>
              <tbody>
                {% for row in stock_df.itertuples() %}
                <tr>
                  <td>{{ row.item }}</td>
                  <td>{{ row.stock }}</td>
                  <td>{{ row.category }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- アラート -->
      <div class="col-md-6" id="alerts">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">⚠ 最新アラート</h6>
            <ul class="list-group list-group-flush">
              {% for row in alert_df.itertuples() %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ row.date }} - {{ row.message }}</span>
                <span class="badge bg-danger">{{ row.level }}</span>
              </li>
              {% endfor %}
              {% if alert_df.empty %}
              <li class="list-group-item text-muted">アラートはありません</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById("salesChart");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: {{ chart_labels|tojson }},
      datasets: [{
        label: "売上 (円)",
        data: {{ chart_values|tojson }},
        backgroundColor: "rgba(54, 162, 235, 0.7)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
</script>

{% endblock %}

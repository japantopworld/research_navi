{% extends "base/layout.html" %}
{% block title %}商品検索 | リサーチナビ{% endblock %}
{% block content %}

<h1>🔎 商品検索（バーコード / ASIN 対応）</h1>

<p class="muted">
  カメラでバーコード（JAN/EAN/UPC）を読み取るか、ASIN・キーワードを入力して検索します。<br>
  「検索」で <b>/history</b> にキーワードを渡します。
</p>

<div class="card">
  <form id="f" method="get" action="{{ url_for('history') }}">
    <div class="grid">
      <label class="grow">
        <span>キーワード / ASIN / バーコード</span>
        <input id="kw" name="keyword" placeholder="例）B0XXXXXX10 / 4988001234567 / Switch / LEGO など" autocomplete="off" required>
      </label>

      <label>
        <span>プラットフォーム</span>
        <select name="platform">
          <option value="">ALL</option>
          <option>Amazon</option>
          <option>楽天</option>
          <option>Yahoo</option>
          <option>メルカリ</option>
        </select>
      </label>

      <label>
        <span>最低利益（円）</span>
        <input type="number" name="min_profit" inputmode="numeric" placeholder="0" min="0" step="100">
      </label>
    </div>

    <div class="actions">
      <button type="submit">検索（/history を開く）</button>
      <button type="button" id="btnScan" class="ghost" hidden>📷 バーコードをスキャン</button>

      <label id="lblImg" class="ghost" hidden>
        <input type="file" id="imgInput" accept="image/*" hidden>
        画像から読み取る
      </label>
    </div>
  </form>
</div>

<!-- スキャン用プレビュー -->
<div id="scanBox" class="scan" hidden>
  <div class="scan-head">
    <strong>カメラでスキャン中…</strong>
    <button type="button" id="btnClose">閉じる</button>
  </div>
  <video id="video" playsinline></video>
  <div class="hint muted">バーコードを枠内に合わせてください</div>
</div>

<div class="card">
  <h3>使い方メモ</h3>
  <ul class="muted">
    <li>JAN/EAN/UPC を自動検出します。</li>
    <li>ASIN（英数字10桁）も入力OK。</li>
  </ul>
</div>

<style>
.card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;margin:10px 0}
.grid{display:grid;gap:12px;grid-template-columns:1fr 220px 220px}
.grow{grid-column:span 1}
label{display:flex;flex-direction:column;gap:6px}
label>span{font-size:12px;color:#6b7280}
input,select{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.actions button,.actions .ghost{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
.actions .ghost{background:#fff;color:#111;border-color:#e5e7eb}
.muted{color:#6b7280}
.scan{border:1px dashed #cbd5e1;border-radius:12px;padding:10px;background:#f8fafc;margin:10px 0}
.scan-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
#video{width:100%;max-height:360px;background:#000;border-radius:8px}
.hint{font-size:12px;margin-top:6px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>

<!-- ZXing（フォールバック用・iPhone Safari でも動作） -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>

<script>
const $ = s => document.querySelector(s);
const kw = $('#kw');
const btnScan = $('#btnScan');
const lblImg = $('#lblImg');
const imgInput = $('#imgInput');
const scanBox = $('#scanBox');
const video = $('#video');
const btnClose = $('#btnClose');

let stream = null;
let detector = null;           // BarcodeDetector
let zxingReader = null;        // ZXing fallback
let usingZXing = false;

// ===== 機能検出 =====
(async () => {
  // 1) まず BarcodeDetector を試す（Android Chrome など）
  if ('BarcodeDetector' in window) {
    try{
      const formats = await BarcodeDetector.getSupportedFormats();
      detector = new BarcodeDetector({ formats });
      btnScan.hidden = false;
      lblImg.hidden = false;
      return;
    }catch(e){}
  }
  // 2) ダメなら ZXing を使う（iPhone Safari 含む）
  if (window.ZXingBrowser) {
    zxingReader = new ZXingBrowser.BrowserMultiFormatReader();
    usingZXing = true;
    btnScan.hidden = false;
    lblImg.hidden = false;
  } else {
    // どちらも無理な超古い環境
    alert('この端末は自動解析に対応していません。バーコード番号を手入力してください。');
  }
})();

// ===== スキャン開始 =====
btnScan?.addEventListener('click', async () => {
  if (detector) return startNativeScan();
  if (usingZXing) return startZXingScan();
  alert('この端末はスキャン機能に対応していません。');
});

// ===== 画像から解析 =====
imgInput?.addEventListener('change', async (ev) => {
  const file = ev.target.files?.[0];
  if (!file) return;

  // BarcodeDetector の still image
  if (detector) {
    try{
      const bmp = await createImageBitmap(file);
      const codes = await detector.detect(bmp);
      if (codes && codes.length) kw.value = (codes[0].rawValue || '').trim();
      else alert('読み取れませんでした。もう一度お試しください。');
    }catch(e){ alert('解析に失敗しました。'); }
    finally{ imgInput.value = ''; }
    return;
  }

  // ZXing の画像解析
  if (usingZXing) {
    try{
      const url = URL.createObjectURL(file);
      const res = await zxingReader.decodeFromImageUrl(url);
      kw.value = res.getText();
    }catch(e){ alert('読み取れませんでした。もう一度お試しください。'); }
    finally{
      URL.revokeObjectURL(url);
      imgInput.value = '';
    }
    return;
  }

  alert('この端末は画像からの自動解析に対応していません。バーコード番号を手入力してください。');
});

// ====== BarcodeDetector（ネイティブ） ======
async function startNativeScan(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
  }catch(e){
    alert('カメラ権限を許可してください。');
    return;
  }
  video.srcObject = stream;
  await video.play();
  scanBox.hidden = false;
  requestAnimationFrame(tickNative);
}

async function tickNative(){
  if (scanBox.hidden || !detector) return;
  try{
    const barcodes = await detector.detect(video);
    if (barcodes && barcodes.length){
      const raw = (barcodes[0].rawValue || '').trim();
      if (raw){
        kw.value = raw;
        stopNative();
      }
      return;
    }
  }catch(e){}
  requestAnimationFrame(tickNative);
}

function stopNative(){
  scanBox.hidden = true;
  try{
    video.pause();
    if (stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }catch(e){}
}

// ====== ZXing フォールバック ======
async function startZXingScan(){
  scanBox.hidden = false;

  // 利用可能カメラから背面を優先
  try{
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const back = (devices || []).find(d => /back|environment/i.test(d.label))?.deviceId
              || (devices[0] && devices[0].deviceId)
              || undefined;

    await zxingReader.decodeFromVideoDevice(back, video, (result, err, controls) => {
      if (result) {
        kw.value = result.getText();
        controls.stop();
        scanBox.hidden = true;
      }
    });
  }catch(e){
    scanBox.hidden = true;
    alert('カメラが使用できませんでした。権限やブラウザ設定を確認してください。');
  }
}

btnClose?.addEventListener('click', () => {
  if (detector) stopNative();
  if (usingZXing && zxingReader) { try{ zxingReader.reset(); }catch(e){} scanBox.hidden = true; }
});
</script>

{% endblock %}

{% extends "base/layout.html" %}
{% block title %}検索 | リサーチナビ{% endblock %}
{% block content %}

<h1>商品検索（バーコード / ASIN 対応）</h1>
<p>カメラでバーコード（JAN/EAN/UPC）を読み取るか、ASIN・キーワードを入力して検索します。</p>

<form method="get" action="{{ url_for('search') }}">
  <div class="field">
    <label for="keyword">キーワード / ASIN / バーコード</label>
    <input id="keyword" name="q" type="text"
           placeholder="例: 4988001234567 / Switch / LEGO など" autocomplete="off"
           style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:.5rem;">
  </div>

  <div class="actions" style="display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0;">
    <button type="button" id="btn-start-scan">📷 バーコードをスキャン</button>
    <button type="button" id="btn-stop-scan" style="display:none">■ 停止</button>

    <label class="img-btn" style="display:inline-block;">
      <input type="file" id="pick-image" accept="image/*" hidden>
      <span style="display:inline-block;padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff;cursor:pointer;">🖼 画像から読み取る</span>
    </label>

    <button type="submit">🔎 検索</button>
  </div>

  <div id="reader-wrap" style="display:none;margin-top:12px">
    <div id="reader" style="width:320px;max-width:100%;"></div>
  </div>
</form>

<!-- html5-qrcode（CDN） -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
<script>
  let html5Qr, scanning = false;

  const formats = [
    Html5QrcodeSupportedFormats.EAN_13,
    Html5QrcodeSupportedFormats.EAN_8,
    Html5QrcodeSupportedFormats.UPC_A,
    Html5QrcodeSupportedFormats.UPC_E,
    Html5QrcodeSupportedFormats.CODE_39,
    Html5QrcodeSupportedFormats.CODE_128
  ];

  function ensureInstance() {
    if (!html5Qr) html5Qr = new Html5Qrcode("reader", { verbose: false });
  }

  async function startScan() {
    try {
      ensureInstance();

      // UI
      document.getElementById("reader-wrap").style.display = "block";
      document.getElementById("btn-start-scan").style.display = "none";
      document.getElementById("btn-stop-scan").style.display = "inline-block";

      // iOS対策：まずカメラ一覧から背面らしき deviceId を選ぶ
      const cams = await Html5Qrcode.getCameras();
      if (!cams || cams.length === 0) throw new Error("カメラが検出できません（Safariのカメラ許可を確認）");

      let deviceId = cams[0].id;
      for (const c of cams) {
        const l = (c.label || "").toLowerCase();
        if (l.includes("back") || l.includes("rear") || l.includes("environment")) { deviceId = c.id; break; }
      }

      const config = { fps: 10, qrbox: 250, formatsToSupport: formats };
      await html5Qr.start({ deviceId }, config, onDecoded, onScanError);
      scanning = true;

    } catch (e) {
      stopScan();
      alert(
        "この端末ではカメラ解析ライブラリが利用できませんでした。\n" +
        "・設定>Safari>カメラ を『許可』\n" +
        "・プライベートブラウズ/コンテンツブロッカーをOFF\n" +
        "・HTTPS（onrenderのURL）で開く\n\n詳細: " + e
      );
    }
  }

  function onDecoded(text) {
    document.getElementById("keyword").value = text;
    stopScan(); // 一件読めたら停止
  }

  function onScanError(_err) { /* 連続エラーは握りつぶす */ }

  async function stopScan() {
    try {
      if (html5Qr && scanning) {
        await html5Qr.stop();
        await html5Qr.clear();
      }
    } finally {
      scanning = false;
      document.getElementById("btn-start-scan").style.display = "inline-block";
      document.getElementById("btn-stop-scan").style.display = "none";
      document.getElementById("reader-wrap").style.display = "none";
    }
  }

  // 画像から読み取り
  document.getElementById("pick-image").addEventListener("change", async (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    try {
      ensureInstance();
      const result = await html5Qr.scanFile(file, true);
      document.getElementById("keyword").value = result;
    } catch {
      alert("画像から読み取れませんでした。別の写真でお試しください。");
    } finally {
      ev.target.value = "";
    }
  });

  // ボタン紐付け
  document.getElementById("btn-start-scan").addEventListener("click", startScan);
  document.getElementById("btn-stop-scan").addEventListener("click", stopScan);
</script>

{% endblock %}

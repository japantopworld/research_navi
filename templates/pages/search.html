{% raw %}<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>商品検索（バーコード / ASIN 対応）</title>

  <!-- ローカルの html5-qrcode を読み込む -->
  <script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif;line-height:1.6;padding:16px}
    .btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:.6em 1em;margin:.2em .4em .2em 0}
    .btn:active{opacity:.85}
    .input{width:100%;padding:.7em;border:1px solid #e5e7eb;border-radius:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    #scanPanel{display:none;margin-top:12px}
    #qr-reader{width:100%;max-width:420px;margin-top:8px}
    .pill{background:#eef2ff;color:#1e3a8a;padding:.45em .9em;border-radius:999px;display:inline-block}
  </style>

  <script>
  // スキャナハンドラ
  let __scanner = null;

  function libReady(){
    return !!(window.Html5Qrcode && window.Html5QrcodeSupportedFormats);
  }

  function show(el, yes){ el.style.display = yes ? '' : 'none'; }

  function onScanSuccess(decodedText, decodedResult){
    const input = document.getElementById('q');
    input.value = decodedText || '';
    stopScan();
    // 必要なら自動検索トリガ
    // document.getElementById('btnSearch').click();
    alert('読み取り: ' + decodedText);
  }

  function onScanFailure(err){ /* 連続で来るのでログは控えめ */ }

  async function startScan(){
    if (!libReady()){
      alert('スキャンライブラリが読み込めていません。ページ再読込を試してください。');
      return;
    }
    // カメラ権限チェック
    try{
      await navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => s.getTracks().forEach(t => t.stop()));
    }catch(e){
      alert('カメラが使えません: ' + e);
      return;
    }

    const regionId = "qr-reader";
    const formats = [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.QR_CODE     // 念のためQRも
    ];
    const config = { fps: 10, rememberLastUsedCamera: true, formatsToSupport: formats };

    show(document.getElementById('scanPanel'), true);

    __scanner = new Html5Qrcode(regionId);
    const cameras = await Html5Qrcode.getCameras();
    const camId = (cameras && cameras[0] && cameras[0].id) || { facingMode: "environment" };

    __scanner.start(
      camId,
      config,
      onScanSuccess,
      onScanFailure
    ).catch(e => {
      alert('起動に失敗しました: ' + e);
      show(document.getElementById('scanPanel'), false);
    });
  }

  function stopScan(){
    if (__scanner){
      __scanner.stop().then(() => {
        __scanner.clear();
        __scanner = null;
        show(document.getElementById('scanPanel'), false);
      }).catch(() => {
        // 停止失敗時もパネルを閉じる
        show(document.getElementById('scanPanel'), false);
      });
    } else {
      show(document.getElementById('scanPanel'), false);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // 診断：ライブラリロード済みバッジ
    const ok = !!(window.Html5Qrcode || window.Html5QrcodeScanner);
    document.getElementById('libBadge').textContent = ok ? 'html5-qrcode 読込OK' : 'ライブラリ未読込';
    document.getElementById('libBadge').style.background = ok ? '#dcfce7' : '#fee2e2';
    document.getElementById('libBadge').style.color = ok ? '#065f46' : '#991b1b';
  });
  </script>
</head>

<body>
  <span class="pill" id="libBadge">checking...</span>

  <h1>商品検索（バーコード / ASIN 対応）</h1>

  <div class="row" style="margin-top:8px">
    <input id="q" class="input" placeholder="例: 4988001234567 / Switch など">
    <button id="btnSearch" class="btn">🔎 検索</button>
    <button class="btn" onclick="startScan()">📷 バーコードをスキャン</button>
  </div>

  <!-- スキャンパネル -->
  <div id="scanPanel" class="card">
    <div style="margin-top:6px">
      <button class="btn" onclick="stopScan()">■ 停止</button>
    </div>
    <div id="qr-reader"></div>
    <p style="font-size:.9em;color:#6b7280;margin-top:6px">
      うまく読み取れない場合は明るい場所で、バーコード全体が入るようにカメラを少し離して試してください。
    </p>
  </div>

  <!-- 検索の submit はアプリ都合に合わせて実装してください -->
</body>
</html>{% endraw %}

{% extends "base/layout.html" %}
{% block title %}æ¤œç´¢ | ãƒªã‚µãƒ¼ãƒãƒŠãƒ“{% endblock %}
{% block content %}

<h1>å•†å“æ¤œç´¢ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / ASIN å¯¾å¿œï¼‰</h1>
<p>ã‚«ãƒ¡ãƒ©ã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆJAN/EAN/UPCï¼‰ã‚’èª­ã¿å–ã‚‹ã‹ã€ASINãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¾ã™ã€‚</p>

<form method="get" action="{{ url_for('search') }}">
  <div class="field">
    <label for="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ / ASIN / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</label>
    <input id="keyword" name="q" type="text"
           placeholder="ä¾‹: 4988001234567 / Switch / LEGO ãªã©" autocomplete="off"
           style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:.5rem;">
  </div>

  <div class="actions" style="display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0;">
    <button type="button" id="btn-start-scan">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button type="button" id="btn-stop-scan" style="display:none">â–  åœæ­¢</button>

    <!-- å¤±æ•—æ™‚ã®ä¿é™ºï¼šå†™çœŸ/ç”»åƒã‹ã‚‰è§£æ -->
    <label style="display:inline-block;">
      <input type="file" id="capture" accept="image/*" capture="environment" hidden>
      <span class="btn-like">ğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Š</span>
    </label>
    <label style="display:inline-block;">
      <input type="file" id="pick-image" accept="image/*" hidden>
      <span class="btn-like">ğŸ–¼ ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š</span>
    </label>

    <button type="submit">ğŸ” æ¤œç´¢</button>
  </div>

  <div id="reader-wrap" style="display:none;margin-top:12px">
    <div id="reader" style="width:420px;max-width:100%;aspect-ratio:16/9;border:1px solid #e5e7eb;border-radius:.5rem;"></div>
    <div style="font-size:.82rem;color:#6b7280;margin-top:.25rem">
      èª­ã‚ãªã„å ´åˆã¯ã€ŒğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Šã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <div id="log" style="font-size:.78rem;color:#6b7280;margin-top:.5rem;"></div>
</form>

<style>
  .btn-like{display:inline-block;padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff;cursor:pointer}
</style>

<!-- html5-qrcode ã‚’ â€œè‡ªå‰ â†’ CDNâ€ ã®é †ã«å‹•çš„ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºå®ŸåŒ– -->
<script>
(function(){
  const logEl = document.getElementById('log');
  const log = (m)=>{ if(logEl) logEl.textContent = m || ''; };

  function loadScript(src, done){
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = ()=>done(null);
    s.onerror = ()=>done(new Error('load failed: '+src));
    document.head.appendChild(s);
  }

  // 1) ã¾ãšè‡ªå‰é…ä¿¡ï¼ˆã‚ã‚‹å ´åˆï¼‰â†’ 2) å¤±æ•—ã—ãŸã‚‰CDN
  const selfHosted = "{{ url_for('static', filename='lib/html5-qrcode.min.js') }}";
  const cdnHosted  = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js";

  loadScript(selfHosted, (err)=>{
    if(err){
      loadScript(cdnHosted, (err2)=>{
        if(err2){
          alert("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }else{
          initScanner();
        }
      });
    }else{
      initScanner();
    }
  });

  // ===== ã‚¹ã‚­ãƒ£ãƒŠæœ¬ä½“ =====
  function initScanner(){
    if(!window.Html5Qrcode){ alert("åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); return; }

    let html5Qr = null;
    let scanning = false;

    const $ = (q)=>document.querySelector(q);
    const readerWrap = $('#reader-wrap');
    const btnStart = $('#btn-start-scan');
    const btnStop  = $('#btn-stop-scan');
    const keyword  = $('#keyword');

    const formats = [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_39,
      Html5QrcodeSupportedFormats.CODE_128
    ];

    function ensureInstance(){
      if(!html5Qr) html5Qr = new Html5Qrcode("reader", { verbose:false });
    }

    function chooseRear(cams){
      let id = cams[0].id;
      for(const c of cams){
        const l = (c.label||'').toLowerCase();
        if(l.includes('back') || l.includes('rear') || l.includes('environment')) { id = c.id; break; }
      }
      return id;
    }

    async function startScan(){
      try{
        ensureInstance();

        // UI
        readerWrap.style.display = 'block';
        btnStart.style.display = 'none';
        btnStop.style.display  = 'inline-block';
        log('èµ·å‹•ä¸­â€¦ ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚');

        // äº‹å‰ã«æ¨©é™ã‚’å–ã‚Šã«è¡Œãï¼ˆiOSå®‰å®šåŒ–ï¼‰
        try{
          const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
          s.getTracks().forEach(t=>t.stop());
        }catch(_){}

        const qrboxW = Math.min(480, window.innerWidth-24);
        const config = {
          fps: 20,
          // 1Dãƒãƒ¼ã‚³ãƒ¼ãƒ‰å‘ã‘ã«æ¨ªé•·ã®æ 
          qrbox: { width: qrboxW, height: Math.round(qrboxW*0.6) },
          formatsToSupport: formats,
          experimentalFeatures: { useBarCodeDetectorIfSupported: true },
          aspectRatio: 1.777,
          disableFlip: true,
          rememberLastUsedCamera: true
        };

        // facingMode â†’ å¤±æ•—æ™‚ã¯ deviceId ã§å†è©¦è¡Œ
        try{
          await html5Qr.start({ facingMode: "environment" }, config, onDecoded, onScanError);
        }catch(e1){
          const cams = await Html5Qrcode.getCameras();
          if(!cams || cams.length===0) throw e1;
          const id = chooseRear(cams);
          await html5Qr.start({ deviceId: id }, config, onDecoded, onScanError);
        }
        scanning = true;
        log('ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ ã„ã£ã±ã„ã«è¿‘ã¥ã‘ã¦ãã ã•ã„ã€‚');

        // 8ç§’ãƒ’ãƒƒãƒˆã—ãªã‘ã‚Œã°ãƒ’ãƒ³ãƒˆ
        setTimeout(()=>{ if(scanning) log('èª­ã‚ãªã„å ´åˆã¯ã€ŒğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Šã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'); }, 8000);

      }catch(e){
        stopScan();
        alert(
          "ã‚¹ã‚­ãƒ£ãƒŠåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" +
          "ãƒ»è¨­å®š>Safari>ã‚«ãƒ¡ãƒ© ã‚’ã€è¨±å¯ã€\n" +
          "ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚º/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’OFF\n" +
          "ãƒ»HTTPSã®URLã§é–‹ã„ã¦ã„ã‚‹ã‹\n\nè©³ç´°: " + e
        );
      }
    }

    function onDecoded(text){
      keyword.value = text;
      log('èª­ã¿å–ã‚ŠæˆåŠŸ: ' + text);
      stopScan(); // 1å›èª­ã‚ãŸã‚‰åœæ­¢
    }
    function onScanError(_e){ /* æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã¯æ¨ã¦ã‚‹ */ }

    async function stopScan(){
      try{
        if(html5Qr && scanning){
          await html5Qr.stop();
          await html5Qr.clear();
        }
      }finally{
        scanning=false;
        btnStart.style.display='inline-block';
        btnStop.style.display='none';
        readerWrap.style.display='none';
        log('');
      }
    }

    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è§£æï¼ˆé™æ­¢ç”»ãŒä¸€ç•ªç¢ºå®Ÿãªç«¯æœ«ã‚‚ã‚ã‚‹ï¼‰
    async function decodeFromFile(file){
      try{
        ensureInstance();
        const result = await html5Qr.scanFile(file, true);
        keyword.value = result;
        log('ç”»åƒã‹ã‚‰èª­ã¿å–ã‚ŠæˆåŠŸ: ' + result);
      }catch(_){
        alert('ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå¤§ããã‚¯ãƒƒã‚­ãƒªå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    // ãƒœã‚¿ãƒ³çµç·š
    btnStart.addEventListener('click', startScan);
    btnStop .addEventListener('click', stopScan);
    document.getElementById('capture').addEventListener('change', async (ev)=>{ const f=ev.target.files?.[0]; if(f) await decodeFromFile(f); ev.target.value=''; });
    document.getElementById('pick-image').addEventListener('change', async (ev)=>{ const f=ev.target.files?.[0]; if(f) await decodeFromFile(f); ev.target.value=''; });
  }
})();
</script>

{% endblock %}

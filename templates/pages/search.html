{% extends "base/layout.html" %}
{% block title %}検索（確認用） | リサーチナビ{% endblock %}
{% block content %}

<div class="flash" style="margin:12px 0">
  <div>SEARCH SETUP OK（確認用ミニマム版）</div>
</div>

<h1>商品検索（確認用）</h1>
<p>まずはテンプレートが正しく読めているか、そしてスキャン用ライブラリが読み込めるかだけ確認します。</p>

<!-- 診断（CDN読込チェック用） -->
<div class="card" style="margin:16px 0;padding:12px;border:1px solid #e5e7eb;border-radius:10px">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button type="button" class="btn" onclick="diagJs()">① JS動作確認</button>
    <button type="button" class="btn" onclick="diagCdn()">② CDN読込確認（html5-qrcode）</button>
  </div>
  <pre id="diagOut" style="margin-top:10px;background:#111;color:#0f0;padding:8px;border-radius:8px;max-height:160px;overflow:auto">{}</pre>
</div>

<!-- いつもの検索フォーム（内容はそのままでOK） -->
<form action="{{ url_for('search') }}" method="get" style="display:flex;gap:8px;flex-wrap:wrap">
  <input type="text" name="q" placeholder="例: 4988001234567 / Switch など" style="flex:1;min-width:240px;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
  <button type="submit" class="btn" style="padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff">🔎 検索</button>
</form>

<!-- ページ専用スクリプト -->
<script>
/* ======== 診断ユーティリティ ======== */
const out = (obj) => {
  const el = document.getElementById('diagOut');
  if (el) el.textContent = JSON.stringify(obj, null, 2);
};
function diagJs() {
  alert('JSは動いています（OK）');
  out({ ok: true, userAgent: navigator.userAgent, time: new Date().toISOString() });
}

/* ======== html5-qrcode を遅延読み込み ======== */
let html5QrcodeLoaded = false;
function loadHtml5Qrcode() {
  return new Promise((resolve, reject) => {
    if (window.Html5Qrcode || window.Html5QrcodeScanner) {
      html5QrcodeLoaded = true;
      return resolve('already');
    }
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js';
    s.crossOrigin = 'anonymous';
    s.referrerPolicy = 'no-referrer';
    s.onload = () => { html5QrcodeLoaded = true; resolve('loaded'); };
    s.onerror = () => reject(new Error('cdn-load-failed'));
    document.head.appendChild(s);
  });
}

/* ② CDN 読込確認 */
async function diagCdn() {
  try {
    const status = await loadHtml5Qrcode();
    alert('html5-qrcode の読み込み成功！');
    out({ html5QrcodeLoaded, status });
  } catch (e) {
    alert('html5-qrcode が読み込めませんでした。通信/フィルタ/キャッシュをご確認ください。');
    out({ html5QrcodeLoaded, error: String(e) });
  }
}
</script>

{% endblock %}

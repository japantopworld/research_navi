{% extends "base/layout.html" %}
{% block title %}æ¤œç´¢[DEBUG] | ãƒªã‚µãƒ¼ãƒãƒŠãƒ“{% endblock %}
{% block content %}

<!-- â–¼â–¼ ã“ã‚ŒãŒè¦‹ãˆãŸã‚‰æ–°ãƒ†ãƒ³ãƒ—ãƒ¬ã¯é…ä¿¡ã§ãã¦ã„ã¾ã™ â–¼â–¼ -->
<div class="debug-banner">SEARCH DEBUG v2025-08-17-3</div>

<h1>å•†å“æ¤œç´¢ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / ASIN å¯¾å¿œï¼‰</h1>
<p>ã¾ãšã¯ã€Œè¨ºæ–­ã€ãƒœã‚¿ãƒ³ã§ã€<b>é…ä¿¡ãƒ»JSãƒ»ã‚«ãƒ¡ãƒ©æ¨©é™</b>ãŒæ­£ã—ãå‹•ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚</p>

<!-- è¨ºæ–­UI -->
<div class="card">
  <h3>è¨ºæ–­</h3>
  <div class="diag-actions">
    <button id="btn-check-js">â‘  JSå‹•ä½œç¢ºèª</button>
    <button id="btn-check-cdn">â‘¡ CDNèª­è¾¼ç¢ºèªï¼ˆhtml5-qrcodeï¼‰</button>
    <button id="btn-check-camera">â‘¢ ã‚«ãƒ¡ãƒ©æ¨©é™ãƒã‚§ãƒƒã‚¯</button>
    <button id="btn-cache-bust">â‘£ å¼·åˆ¶å†èª­è¾¼ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–ï¼‰</button>
  </div>
  <pre id="diag-log" class="diag-log">ã“ã“ã«çµæœãŒå‡ºã¾ã™</pre>
</div>

<!-- å…¥åŠ›UI -->
<form method="get" action="{{ url_for('search') }}">
  <div class="field">
    <label for="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ / ASIN / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</label>
    <input id="keyword" name="q" type="text"
           placeholder="ä¾‹: 4988001234567 / Switch / LEGO ãªã©" autocomplete="off"
           style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:.5rem;">
  </div>

  <div class="actions" style="display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0;">
    <button type="button" id="btn-start-scan">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button type="button" id="btn-stop-scan" style="display:none">â–  åœæ­¢</button>

    <label style="display:inline-block;">
      <input type="file" id="capture" accept="image/*" capture="environment" hidden>
      <span class="btn-like">ğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Š</span>
    </label>
    <label style="display:inline-block;">
      <input type="file" id="pick-image" accept="image/*" hidden>
      <span class="btn-like">ğŸ–¼ ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š</span>
    </label>

    <button type="submit">ğŸ” æ¤œç´¢</button>
  </div>

  <div id="reader-wrap" style="display:none;margin-top:12px">
    <div id="reader" style="width:420px;max-width:100%;aspect-ratio:16/9;border:1px solid #e5e7eb;border-radius:.5rem;"></div>
    <div style="font-size:.82rem;color:#6b7280;margin-top:.25rem">
      èª­ã‚ãªã„å ´åˆã¯ã€ŒğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Šã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <div id="log" style="font-size:.78rem;color:#6b7280;margin-top:.5rem;"></div>
</form>

<style>
  .debug-banner{
    background:#fff3c4;border:1px solid #facc15;color:#7c2d12;
    padding:10px;border-radius:10px;margin:8px 0;font-weight:700;text-align:center
  }
  .card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;margin:10px 0}
  .btn-like{display:inline-block;padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff;cursor:pointer}
  .diag-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0}
  .diag-log{background:#0b1020;color:#d1e7ff;padding:8px;border-radius:8px;min-height:64px;white-space:pre-wrap}
</style>

<!-- html5-qrcodeï¼ˆCDNï¼‰â€»ã‚¯ã‚¨ãƒªã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ– -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js?v=2025-08-17-3"></script>
<script>
  // ====== è¨ºæ–­ãƒ­ã‚¬ãƒ¼ ======
  const DL = document.getElementById('diag-log');
  const logDiag = (obj) => {
    DL.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
  };

  // â‘  JSå‹•ä½œç¢ºèª
  document.getElementById('btn-check-js').addEventListener('click', () => {
    const info = {
      time: new Date().toISOString(),
      userAgent: navigator.userAgent,
      location: window.location.href,
      templateVersion: 'SEARCH DEBUG v2025-08-17-3',
    };
    logDiag(info);
    alert('JSã¯å‹•ã„ã¦ã„ã¾ã™ï¼ˆOKï¼‰');
  });

  // â‘¡ CDNèª­è¾¼ç¢ºèª
  document.getElementById('btn-check-cdn').addEventListener('click', () => {
    const ok = !!window.Html5Qrcode;
    logDiag({ html5QrcodeLoaded: ok });
    alert(ok ? 'html5-qrcode èª­è¾¼OK' : 'html5-qrcode ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ï¼');
  });

  // â‘¢ ã‚«ãƒ¡ãƒ©æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ï¼‰
  document.getElementById('btn-check-camera').addEventListener('click', async () => {
    try{
      const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
      s.getTracks().forEach(t => t.stop());
      logDiag('ã‚«ãƒ¡ãƒ©: è¨±å¯OKï¼ˆgetUserMediaæˆåŠŸï¼‰');
      alert('ã‚«ãƒ¡ãƒ©è¨±å¯OK');
    }catch(e){
      logDiag('ã‚«ãƒ¡ãƒ©: å¤±æ•— ' + e);
      alert('ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ã€‚Safariã®è¨­å®šã§è¨±å¯ã«ã—ã¦ãã ã•ã„ã€‚');
    }
  });

  // â‘£ å¼·åˆ¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼
  document.getElementById('btn-cache-bust').addEventListener('click', () => {
    const u = new URL(window.location.href);
    u.searchParams.set('cb', Date.now());
    window.location.href = u.href;
  });

  // ====== å®Ÿéš›ã®ã‚¹ã‚­ãƒ£ãƒŠï¼ˆæœ€ä½é™ï¼‰ ======
  let html5Qr, scanning=false;
  const formats = [
    Html5QrcodeSupportedFormats.EAN_13,
    Html5QrcodeSupportedFormats.EAN_8,
    Html5QrcodeSupportedFormats.UPC_A,
    Html5QrcodeSupportedFormats.UPC_E,
    Html5QrcodeSupportedFormats.CODE_39,
    Html5QrcodeSupportedFormats.CODE_128
  ];
  const $ = (q)=>document.querySelector(q);
  const log = (m)=>{$('#log').textContent = m||''}

  function ensureHtml5(){ if(!html5Qr) html5Qr = new Html5Qrcode('reader', { verbose:false }); }

  function chooseRear(cams){
    let id=cams[0].id;
    for(const c of cams){
      const l=(c.label||'').toLowerCase();
      if(l.includes('back')||l.includes('rear')||l.includes('environment')){ id=c.id; break; }
    }
    return id;
  }

  async function startScan(){
    try{
      ensureHtml5();
      $('#reader-wrap').style.display='block';
      $('#btn-start-scan').style.display='none';
      $('#btn-stop-scan').style.display='inline-block';
      log('èµ·å‹•ä¸­â€¦');

      // äº‹å‰æ¨©é™ï¼ˆå®‰å®šåŒ–ï¼‰
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' } } });
        s.getTracks().forEach(t => t.stop());
      }catch(_){}

      const qrboxW = Math.min(480, window.innerWidth-24);
      const config = {
        fps: 20,
        qrbox: { width: qrboxW, height: Math.round(qrboxW * 0.6) }, // 1Då‘ã‘
        formatsToSupport: formats,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        aspectRatio: 1.777,
        disableFlip: true,
        rememberLastUsedCamera: true
      };

      // facingMode â†’ å¤±æ•—æ™‚ deviceId
      try{
        await html5Qr.start({ facingMode: 'environment' }, config, onDecoded, onScanError);
      }catch(e1){
        const cams = await Html5Qrcode.getCameras();
        if(!cams || cams.length===0) throw e1;
        const id = chooseRear(cams);
        await html5Qr.start({ deviceId: id }, config, onDecoded, onScanError);
      }
      scanning=true;
      log('ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦ æ ã„ã£ã±ã„ã«è¿‘ã¥ã‘ã¦ãã ã•ã„ã€‚');

    }catch(e){
      stopScan();
      alert('ã‚¹ã‚­ãƒ£ãƒŠåˆæœŸåŒ–ã«å¤±æ•—: ' + e);
    }
  }

  function onDecoded(text){
    document.getElementById('keyword').value = text;
    log('èª­ã¿å–ã‚ŠæˆåŠŸ: ' + text);
    stopScan();
  }
  function onScanError(_e){ /* æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã¯æ¨ã¦ã‚‹ */ }

  async function stopScan(){
    try{
      if(html5Qr && scanning){ await html5Qr.stop(); await html5Qr.clear(); }
    }finally{
      scanning=false;
      $('#btn-start-scan').style.display='inline-block';
      $('#btn-stop-scan').style.display='none';
      $('#reader-wrap').style.display='none';
      log('');
    }
  }

  // ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆç°¡æ˜“ï¼šã¾ãšã¯html5-qrcodeï¼‰
  async function decodeWithHtml5(file){
    try{
      const r = await html5Qr.scanFile(file, true);
      document.getElementById('keyword').value = r;
      log('ç”»åƒã‹ã‚‰èª­ã¿å–ã‚ŠæˆåŠŸ: ' + r);
    }catch(_){
      alert('ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å¤§ããæ’®ã£ã¦ãã ã•ã„ã€‚');
    }
  }

  // ãƒœã‚¿ãƒ³
  document.getElementById('btn-start-scan').addEventListener('click', startScan);
  document.getElementById('btn-stop-scan').addEventListener('click', stopScan);
  document.getElementById('capture').addEventListener('change', async (ev)=>{
    const f = ev.target.files?.[0]; if(!f) return;
    if(!html5Qr) html5Qr = new Html5Qrcode('reader',{verbose:false});
    await decodeWithHtml5(f); ev.target.value='';
  });
  document.getElementById('pick-image').addEventListener('change', async (ev)=>{
    const f = ev.target.files?.[0]; if(!f) return;
    if(!html5Qr) html5Qr = new Html5Qrcode('reader',{verbose:false});
    await decodeWithHtml5(f); ev.target.value='';
  });
</script>

{% endblock %}

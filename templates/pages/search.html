{% raw %}<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å•†å“æ¤œç´¢ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / ASIN å¯¾å¿œï¼‰</title>

  <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã® html5-qrcode ã‚’èª­ã¿è¾¼ã‚€ -->
  <script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif;line-height:1.6;padding:16px}
    .btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:.6em 1em;margin:.2em .4em .2em 0}
    .btn:active{opacity:.85}
    .input{width:100%;padding:.7em;border:1px solid #e5e7eb;border-radius:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    #scanPanel{display:none;margin-top:12px}
    #qr-reader{width:100%;max-width:420px;margin-top:8px}
    .pill{background:#eef2ff;color:#1e3a8a;padding:.45em .9em;border-radius:999px;display:inline-block}
  </style>

  <script>
  // ã‚¹ã‚­ãƒ£ãƒŠãƒãƒ³ãƒ‰ãƒ©
  let __scanner = null;

  function libReady(){
    return !!(window.Html5Qrcode && window.Html5QrcodeSupportedFormats);
  }

  function show(el, yes){ el.style.display = yes ? '' : 'none'; }

  function onScanSuccess(decodedText, decodedResult){
    const input = document.getElementById('q');
    input.value = decodedText || '';
    stopScan();
    // å¿…è¦ãªã‚‰è‡ªå‹•æ¤œç´¢ãƒˆãƒªã‚¬
    // document.getElementById('btnSearch').click();
    alert('èª­ã¿å–ã‚Š: ' + decodedText);
  }

  function onScanFailure(err){ /* é€£ç¶šã§æ¥ã‚‹ã®ã§ãƒ­ã‚°ã¯æ§ãˆã‚ */ }

  async function startScan(){
    if (!libReady()){
      alert('ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸å†èª­è¾¼ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    // ã‚«ãƒ¡ãƒ©æ¨©é™ãƒã‚§ãƒƒã‚¯
    try{
      await navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => s.getTracks().forEach(t => t.stop()));
    }catch(e){
      alert('ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“: ' + e);
      return;
    }

    const regionId = "qr-reader";
    const formats = [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.QR_CODE     // å¿µã®ãŸã‚QRã‚‚
    ];
    const config = { fps: 10, rememberLastUsedCamera: true, formatsToSupport: formats };

    show(document.getElementById('scanPanel'), true);

    __scanner = new Html5Qrcode(regionId);
    const cameras = await Html5Qrcode.getCameras();
    const camId = (cameras && cameras[0] && cameras[0].id) || { facingMode: "environment" };

    __scanner.start(
      camId,
      config,
      onScanSuccess,
      onScanFailure
    ).catch(e => {
      alert('èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
      show(document.getElementById('scanPanel'), false);
    });
  }

  function stopScan(){
    if (__scanner){
      __scanner.stop().then(() => {
        __scanner.clear();
        __scanner = null;
        show(document.getElementById('scanPanel'), false);
      }).catch(() => {
        // åœæ­¢å¤±æ•—æ™‚ã‚‚ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        show(document.getElementById('scanPanel'), false);
      });
    } else {
      show(document.getElementById('scanPanel'), false);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // è¨ºæ–­ï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒãƒƒã‚¸
    const ok = !!(window.Html5Qrcode || window.Html5QrcodeScanner);
    document.getElementById('libBadge').textContent = ok ? 'html5-qrcode èª­è¾¼OK' : 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼';
    document.getElementById('libBadge').style.background = ok ? '#dcfce7' : '#fee2e2';
    document.getElementById('libBadge').style.color = ok ? '#065f46' : '#991b1b';
  });
  </script>
</head>

<body>
  <span class="pill" id="libBadge">checking...</span>

  <h1>å•†å“æ¤œç´¢ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / ASIN å¯¾å¿œï¼‰</h1>

  <div class="row" style="margin-top:8px">
    <input id="q" class="input" placeholder="ä¾‹: 4988001234567 / Switch ãªã©">
    <button id="btnSearch" class="btn">ğŸ” æ¤œç´¢</button>
    <button class="btn" onclick="startScan()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
  </div>

  <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ‘ãƒãƒ« -->
  <div id="scanPanel" class="card">
    <div style="margin-top:6px">
      <button class="btn" onclick="stopScan()">â–  åœæ­¢</button>
    </div>
    <div id="qr-reader"></div>
    <p style="font-size:.9em;color:#6b7280;margin-top:6px">
      ã†ã¾ãèª­ã¿å–ã‚Œãªã„å ´åˆã¯æ˜ã‚‹ã„å ´æ‰€ã§ã€ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å…¨ä½“ãŒå…¥ã‚‹ã‚ˆã†ã«ã‚«ãƒ¡ãƒ©ã‚’å°‘ã—é›¢ã—ã¦è©¦ã—ã¦ãã ã•ã„ã€‚
    </p>
  </div>

  <!-- æ¤œç´¢ã® submit ã¯ã‚¢ãƒ—ãƒªéƒ½åˆã«åˆã‚ã›ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ -->
</body>
</html>{% endraw %}

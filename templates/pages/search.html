{% extends "base/layout.html" %}
{% block title %}å•†å“æ¤œç´¢ | ãƒªã‚µãƒ¼ãƒãƒŠãƒ“{% endblock %}
{% block content %}

<h1>ğŸ” å•†å“æ¤œç´¢ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / ASIN å¯¾å¿œï¼‰</h1>
<p class="muted">
  ã‚«ãƒ¡ãƒ©ã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆJAN/EAN/UPCï¼‰ã‚’èª­ã¿å–ã‚‹ã‹ã€ASINãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¾ã™ã€‚<br>
  ã€Œæ¤œç´¢ã€ã§ <b>/history</b> ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¸¡ã—ã¾ã™ã€‚
</p>

<div class="card">
  <form id="f" method="get" action="{{ url_for('history') }}">
    <div class="grid">
      <label class="grow">
        <span>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ / ASIN / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</span>
        <input id="kw" name="keyword" placeholder="ä¾‹ï¼‰B0XXXXXX10 / 4988001234567 / Switch / LEGO ãªã©" autocomplete="off" required>
      </label>

      <label>
        <span>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </span>
        <select name="platform">
          <option value="">ALL</option>
          <option>Amazon</option>
          <option>æ¥½å¤©</option>
          <option>Yahoo</option>
          <option>ãƒ¡ãƒ«ã‚«ãƒª</option>
        </select>
      </label>

      <label>
        <span>æœ€ä½åˆ©ç›Šï¼ˆå††ï¼‰</span>
        <input type="number" name="min_profit" inputmode="numeric" placeholder="0" min="0" step="100">
      </label>
    </div>

    <div class="actions">
      <button type="submit">æ¤œç´¢ï¼ˆ/history ã‚’é–‹ãï¼‰</button>
      <button type="button" id="btnScan" class="ghost">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
      <label id="lblImg" class="ghost">
        <input type="file" id="imgInput" accept="image/*" hidden>
        ç”»åƒã‹ã‚‰èª­ã¿å–ã‚‹
      </label>
    </div>
  </form>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒ³ç”¨UI -->
<div id="scanBox" class="scan" hidden>
  <div class="scan-head">
    <strong id="scanTitle">ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦</strong>
    <button type="button" id="btnClose">é–‰ã˜ã‚‹</button>
  </div>
  <!-- BarcodeDetector / ZXing ç”¨ -->
  <video id="video" playsinline style="width:100%;max-height:360px;background:#000;border-radius:8px"></video>
  <!-- Quagga ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="quaggaArea" style="position:relative;width:100%;max-height:360px;border-radius:8px;overflow:hidden"></div>
  <div class="hint muted">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„</div>
</div>

<style>
.card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;margin:10px 0}
.grid{display:grid;gap:12px;grid-template-columns:1fr 220px 220px}
.grow{grid-column:span 1}
label{display:flex;flex-direction:column;gap:6px}
label>span{font-size:12px;color:#6b7280}
input,select{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.actions button,.actions .ghost{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
.actions .ghost{background:#fff;color:#111;border-color:#e5e7eb}
.muted{color:#6b7280}
.scan{border:1px dashed #cbd5e1;border-radius:12px;padding:10px;background:#f8fafc;margin:10px 0}
.scan-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.hint{font-size:12px;margin-top:6px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>

<!-- ZXing ã¨ Quagga2 ã‚’èª­ã¿è¾¼ã¿ï¼ˆã©ã¡ã‚‰ã‹ã§ã‚‚OKï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@2.0.0/dist/quagga.min.js"></script>

<script>
const $ = s => document.querySelector(s);
const kw = $('#kw');
const btnScan = $('#btnScan');
const lblImg = $('#lblImg');
const imgInput = $('#imgInput');
const scanBox = $('#scanBox');
const scanTitle = $('#scanTitle');
const video = $('#video');
const quaggaArea = $('#quaggaArea');
const btnClose = $('#btnClose');

let stream = null;
let detector = null;           // BarcodeDetector
let zxingReader = null;        // ZXing fallback
let usingZXing = false;
let usingQuagga = false;

// ===== åˆæœŸåŒ–ï¼šä½¿ãˆã‚‹æ‰‹æ®µã‚’åˆ¤å®š =====
(async () => {
  // BarcodeDetector
  if ('BarcodeDetector' in window) {
    try{
      const formats = await BarcodeDetector.getSupportedFormats();
      detector = new BarcodeDetector({ formats });
    }catch(e){ detector = null; }
  }
  // ZXing
  if (window.ZXingBrowser) {
    zxingReader = new ZXingBrowser.BrowserMultiFormatReader();
    usingZXing = true;
  }
  // Quagga
  if (window.Quagga) {
    usingQuagga = true;
  }
})();

// ====== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ ======
btnScan.addEventListener('click', async () => {
  // å„ªå…ˆé †ï¼šBarcodeDetector â†’ ZXing â†’ Quagga
  if (detector) return startNativeScan();
  if (usingZXing) return startZXingScan();
  if (usingQuagga) return startQuaggaScan();
  alert('ã“ã®ç«¯æœ«ã§ã¯ã‚«ãƒ¡ãƒ©è§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
});

// ===== ç”»åƒã‹ã‚‰è§£æ =====
imgInput.addEventListener('change', async (ev) => {
  const file = ev.target.files?.[0];
  if (!file) return;

  // 1) BarcodeDetector
  if (detector) {
    try{
      const bmp = await createImageBitmap(file);
      const codes = await detector.detect(bmp);
      if (codes && codes.length) kw.value = (codes[0].rawValue || '').trim();
      else alert('èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }catch(e){ alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
    finally{ imgInput.value = ''; }
    return;
  }

  // 2) ZXing
  if (usingZXing) {
    let url;
    try{
      url = URL.createObjectURL(file);
      const res = await zxingReader.decodeFromImageUrl(url);
      kw.value = res.getText();
    }catch(e){ alert('èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'); }
    finally{
      if (url) URL.revokeObjectURL(url);
      imgInput.value = '';
    }
    return;
  }

  // 3) Quaggaï¼ˆé™æ­¢ç”»ãƒ‡ã‚³ãƒ¼ãƒ‰ã¯å¼±ã„ã®ã§æ¡ˆå†…ï¼‰
  if (usingQuagga) {
    alert('ã“ã®ç«¯æœ«ã¯é™æ­¢ç”»ã‹ã‚‰ã®è§£æãŒå¼±ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã€ŒğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
    imgInput.value = '';
    return;
  }

  alert('ã“ã®ç«¯æœ«ã¯ç”»åƒã‹ã‚‰ã®è‡ªå‹•è§£æã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
});

// ====== BarcodeDetectorï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰ ======
async function startNativeScan(){
  scanTitle.textContent = 'ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦ï¼ˆé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰';
  quaggaArea.style.display = 'none';
  video.style.display = 'block';
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
  }catch(e){
    alert('ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ï¼ˆè¨­å®š > ã‚µã‚¤ãƒˆåˆ¥è¨­å®š > ã‚«ãƒ¡ãƒ©ï¼‰ã€‚');
    return;
  }
  video.srcObject = stream;
  await video.play();
  scanBox.hidden = false;
  requestAnimationFrame(tickNative);
}
async function tickNative(){
  if (scanBox.hidden || !detector) return;
  try{
    const barcodes = await detector.detect(video);
    if (barcodes && barcodes.length){
      const raw = (barcodes[0].rawValue || '').trim();
      if (raw){ kw.value = raw; stopNative(); }
      return;
    }
  }catch(e){}
  requestAnimationFrame(tickNative);
}
function stopNative(){
  scanBox.hidden = true;
  try{
    video.pause();
    if (stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
  }catch(e){}
}

// ====== ZXing ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ======
async function startZXingScan(){
  scanTitle.textContent = 'ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦ï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼šZXingï¼‰';
  video.style.display = 'block';
  quaggaArea.style.display = 'none';
  scanBox.hidden = false;

  try{
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const back = (devices || []).find(d => /back|environment/i.test(d.label))?.deviceId
              || (devices[0] && devices[0].deviceId)
              || undefined;

    await zxingReader.decodeFromVideoDevice(back, video, (result, err, controls) => {
      if (result) {
        kw.value = result.getText();
        controls.stop();
        scanBox.hidden = true;
      }
    });
  }catch(e){
    scanBox.hidden = true;
    alert('ZXing ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Quaggaã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
    if (usingQuagga) startQuaggaScan();
  }
}

// ====== Quagga2 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆiPhone Safari ã§å¼·ã„ï¼‰ ======
function startQuaggaScan(){
  scanTitle.textContent = 'ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦ï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼šQuaggaï¼‰';
  video.style.display = 'none';
  quaggaArea.style.display = 'block';
  scanBox.hidden = false;

  const conf = {
    inputStream: {
      name: 'Live',
      type: 'LiveStream',
      target: quaggaArea,
      constraints: { facingMode: 'environment' }
    },
    decoder: {
      readers: [
        'ean_reader','ean_8_reader',
        'upc_reader','upc_e_reader',
        'code_128_reader'
      ]
    },
    locate: true
  };

  Quagga.offDetected(); // äºŒé‡ç™»éŒ²é˜²æ­¢
  Quagga.onDetected(res => {
    const code = res?.codeResult?.code;
    if (code) {
      kw.value = String(code).trim();
      Quagga.stop();
      scanBox.hidden = true;
    }
  });

  Quagga.init(conf, err => {
    if (err) {
      scanBox.hidden = true;
      alert('ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚„ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      return;
    }
    Quagga.start();
  });
}

btnClose.addEventListener('click', () => {
  scanBox.hidden = true;
  try{ if (detector) stopNative(); }catch(e){}
  try{ if (usingZXing && zxingReader) zxingReader.reset(); }catch(e){}
  try{ if (usingQuagga) Quagga.stop(); }catch(e){}
});
</script>

{% endblock %}

{% extends "base/layout.html" %}
{% block title %}æ¤œç´¢ï¼ˆç¢ºèªç”¨ï¼‰ | ãƒªã‚µãƒ¼ãƒãƒŠãƒ“{% endblock %}
{% block content %}

<div class="flash" style="margin:12px 0">
  <div>SEARCH SETUP OKï¼ˆç¢ºèªç”¨ãƒŸãƒ‹ãƒãƒ ç‰ˆï¼‰</div>
</div>

<h1>å•†å“æ¤œç´¢ï¼ˆç¢ºèªç”¨ï¼‰</h1>
<p>ã¾ãšã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£ã—ãèª­ã‚ã¦ã„ã‚‹ã‹ã€ãã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã‚‹ã‹ã ã‘ç¢ºèªã—ã¾ã™ã€‚</p>

<!-- è¨ºæ–­ï¼ˆCDNèª­è¾¼ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰ -->
<div class="card" style="margin:16px 0;padding:12px;border:1px solid #e5e7eb;border-radius:10px">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button type="button" class="btn" onclick="diagJs()">â‘  JSå‹•ä½œç¢ºèª</button>
    <button type="button" class="btn" onclick="diagCdn()">â‘¡ CDNèª­è¾¼ç¢ºèªï¼ˆhtml5-qrcodeï¼‰</button>
  </div>
  <pre id="diagOut" style="margin-top:10px;background:#111;color:#0f0;padding:8px;border-radius:8px;max-height:160px;overflow:auto">{}</pre>
</div>

<!-- ã„ã¤ã‚‚ã®æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå†…å®¹ã¯ãã®ã¾ã¾ã§OKï¼‰ -->
<form action="{{ url_for('search') }}" method="get" style="display:flex;gap:8px;flex-wrap:wrap">
  <input type="text" name="q" placeholder="ä¾‹: 4988001234567 / Switch ãªã©" style="flex:1;min-width:240px;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
  <button type="submit" class="btn" style="padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff">ğŸ” æ¤œç´¢</button>
</form>

<!-- ãƒšãƒ¼ã‚¸å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
/* ======== è¨ºæ–­ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======== */
const out = (obj) => {
  const el = document.getElementById('diagOut');
  if (el) el.textContent = JSON.stringify(obj, null, 2);
};
function diagJs() {
  alert('JSã¯å‹•ã„ã¦ã„ã¾ã™ï¼ˆOKï¼‰');
  out({ ok: true, userAgent: navigator.userAgent, time: new Date().toISOString() });
}

/* ======== html5-qrcode ã‚’é…å»¶èª­ã¿è¾¼ã¿ ======== */
let html5QrcodeLoaded = false;
function loadHtml5Qrcode() {
  return new Promise((resolve, reject) => {
    if (window.Html5Qrcode || window.Html5QrcodeScanner) {
      html5QrcodeLoaded = true;
      return resolve('already');
    }
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js';
    s.crossOrigin = 'anonymous';
    s.referrerPolicy = 'no-referrer';
    s.onload = () => { html5QrcodeLoaded = true; resolve('loaded'); };
    s.onerror = () => reject(new Error('cdn-load-failed'));
    document.head.appendChild(s);
  });
}

/* â‘¡ CDN èª­è¾¼ç¢ºèª */
async function diagCdn() {
  try {
    const status = await loadHtml5Qrcode();
    alert('html5-qrcode ã®èª­ã¿è¾¼ã¿æˆåŠŸï¼');
    out({ html5QrcodeLoaded, status });
  } catch (e) {
    alert('html5-qrcode ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚é€šä¿¡/ãƒ•ã‚£ãƒ«ã‚¿/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
    out({ html5QrcodeLoaded, error: String(e) });
  }
}
</script>

{% endblock %}

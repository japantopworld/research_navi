{% extends "base/layout.html" %}
{% block title %}æ¤œç´¢ | ãƒªã‚µãƒ¼ãƒãƒŠãƒ“{% endblock %}
{% block content %}

<h1>å•†å“æ¤œç´¢ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / ASIN å¯¾å¿œï¼‰</h1>
<p>ã‚«ãƒ¡ãƒ©ã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆJAN/EAN/UPCï¼‰ã‚’èª­ã¿å–ã‚‹ã‹ã€ASINãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¾ã™ã€‚</p>

<form method="get" action="{{ url_for('search') }}">
  <div class="field">
    <label for="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ / ASIN / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</label>
    <input id="keyword" name="q" type="text"
           placeholder="ä¾‹: 4988001234567 / Switch / LEGO ãªã©" autocomplete="off"
           style="width:100%;padding:.6rem;border:1px solid #e5e7eb;border-radius:.5rem;">
  </div>

  <div class="actions" style="display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0;">
    <button type="button" id="btn-start-scan">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button type="button" id="btn-stop-scan" style="display:none">â–  åœæ­¢</button>

    <!-- â‘¢ å†™çœŸã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆiOSã§å¼·ã„ï¼‰ -->
    <label class="img-btn" style="display:inline-block;">
      <input type="file" id="capture" accept="image/*" capture="environment" hidden>
      <span style="display:inline-block;padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff;cursor:pointer;">ğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Š</span>
    </label>

    <!-- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ç”»åƒã‹ã‚‰ã‚‚OK -->
    <label class="img-btn" style="display:inline-block;">
      <input type="file" id="pick-image" accept="image/*" hidden>
      <span style="display:inline-block;padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff;cursor:pointer;">ğŸ–¼ ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š</span>
    </label>

    <button type="submit">ğŸ” æ¤œç´¢</button>
  </div>

  <div id="reader-wrap" style="display:none;margin-top:12px">
    <div id="reader" style="width:320px;max-width:100%;aspect-ratio:1/1;border:1px solid #e5e7eb;border-radius:.5rem;"></div>
    <div style="font-size:.85rem;color:#6b7280;margin-top:.25rem">
      èª­ã¿å–ã‚Œãªã„æ™‚ã¯ã€ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ ã„ã£ã±ã„ã«è¿‘ã¥ã‘ã¦ãã ã•ã„ã€‚æš—ã„å ´æ‰€ã§ã¯æ˜ã‚‹ã•ã‚’ä¸Šã’ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚
    </div>
  </div>
</form>

<!-- html5-qrcodeï¼ˆCDNï¼‰ -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
<script>
  let html5Qr, scanning = false;

  const formats = [
    Html5QrcodeSupportedFormats.EAN_13,
    Html5QrcodeSupportedFormats.EAN_8,
    Html5QrcodeSupportedFormats.UPC_A,
    Html5QrcodeSupportedFormats.UPC_E,
    Html5QrcodeSupportedFormats.CODE_39,
    Html5QrcodeSupportedFormats.CODE_128
  ];

  function ensureInstance() {
    if (!html5Qr) html5Qr = new Html5Qrcode("reader", { verbose: false });
  }

  function chooseRear(cams) {
    let id = cams[0].id;
    for (const c of cams) {
      const l = (c.label || "").toLowerCase();
      if (l.includes("back") || l.includes("rear") || l.includes("environment")) { id = c.id; break; }
    }
    return id;
  }

  async function startScan() {
    try {
      ensureInstance();

      // UI
      document.getElementById("reader-wrap").style.display = "block";
      document.getElementById("btn-start-scan").style.display = "none";
      document.getElementById("btn-stop-scan").style.display = "inline-block";

      // â‘  Safariã§BarcodeDetectorãŒä½¿ãˆã‚‹ãªã‚‰æœ‰åŠ¹åŒ–
      const config = {
        fps: 15,
        qrbox: 250,
        formatsToSupport: formats,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        disableFlip: true
      };

      // â‘¡ äº‹å‰ã«ç’°å¢ƒã‚«ãƒ¡ãƒ©ã§è¨±å¯ã‚’å–ã‚Šã«è¡Œãï¼ˆSafariå®‰å®šåŒ–ï¼‰
      try {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
        s.getTracks().forEach(t => t.stop());
      } catch (_) { /* è¨±å¯ã¯startæ™‚ã«å†æç¤ºã•ã‚Œã‚‹ã®ã§ç„¡è¦– */ }

      // ã¾ãš facingMode ã§èµ·å‹• â†’ å¤±æ•—ãªã‚‰ deviceId æ–¹å¼ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      try {
        await html5Qr.start({ facingMode: "environment" }, config, onDecoded, onScanError);
        scanning = true;
      } catch (e1) {
        const cams = await Html5Qrcode.getCameras();
        if (!cams || cams.length === 0) throw e1;
        const id = chooseRear(cams);
        await html5Qr.start({ deviceId: id }, config, onDecoded, onScanError);
        scanning = true;
      }

      // 8ç§’çµŒã£ã¦ã‚‚ä½•ã‚‚èª­ã‚ãªã„æ™‚ã¯ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
      setTimeout(() => {
        if (scanning) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é™ã‹ã«ãƒ’ãƒ³ãƒˆï¼ˆalertã¯å‡ºã•ãªã„ï¼‰
          console.log("ãƒ’ãƒ³ãƒˆ: æ˜ã‚‹ã•ã‚’ä¸Šã’ã€æ ã„ã£ã±ã„ã«è¿‘ã¥ã‘ã¦ãã ã•ã„ã€‚ã†ã¾ãã„ã‹ãªã‘ã‚Œã°ã€ğŸ“¸ æ’®å½±ã—ã¦èª­ã¿å–ã‚Šã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
      }, 8000);

    } catch (e) {
      stopScan();
      alert(
        "ã“ã®ç«¯æœ«ã§ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚­ãƒ£ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" +
        "ãƒ»è¨­å®š>Safari>ã‚«ãƒ¡ãƒ© ã‚’ã€è¨±å¯ã€\n" +
        "ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚º/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’OFF\n" +
        "ãƒ»HTTPSï¼ˆonrenderã®URLï¼‰ã§é–‹ã\n\nè©³ç´°: " + e
      );
    }
  }

  function onDecoded(text) {
    document.getElementById("keyword").value = text;
    stopScan(); // 1å›èª­ã‚ãŸã‚‰åœæ­¢
  }

  function onScanError(_err) { /* é€£ç¶šã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã™ */ }

  async function stopScan() {
    try {
      if (html5Qr && scanning) {
        await html5Qr.stop();
        await html5Qr.clear();
      }
    } finally {
      scanning = false;
      document.getElementById("btn-start-scan").style.display = "inline-block";
      document.getElementById("btn-stop-scan").style.display = "none";
      document.getElementById("reader-wrap").style.display = "none";
    }
  }

  // â‘¢ å†™çœŸã‚’æ’®ã£ã¦èª­ã¿å–ã‚Šï¼ˆcapture=environment ã§ãƒªã‚¢ã‚«ãƒ¡ãƒ©å¼·åˆ¶ï¼‰
  async function decodeFromFile(file) {
    try {
      ensureInstance();
      const result = await html5Qr.scanFile(file, true); // ç”»åƒã‹ã‚‰è§£æ
      document.getElementById("keyword").value = result;
    } catch {
      alert("ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå¤§ããå†™ã‚‹ã‚ˆã†ã«å†æ’®å½±ã—ã¦ãã ã•ã„ã€‚");
    }
  }

  document.getElementById("capture").addEventListener("change", async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (f) await decodeFromFile(f);
    ev.target.value = "";
  });
  document.getElementById("pick-image").addEventListener("change", async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (f) await decodeFromFile(f);
    ev.target.value = "";
  });

  // ãƒœã‚¿ãƒ³
  document.getElementById("btn-start-scan").addEventListener("click", startScan);
  document.getElementById("btn-stop-scan").addEventListener("click", stopScan);
</script>

{% endblock %}

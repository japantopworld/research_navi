{% extends "base/layout.html" %}
{% block title %}利益計算 | リサーチナビ{% endblock %}
{% block content %}
<h1>利益計算（PF別 手数料オート & ライブ計算）</h1>

<form method="post" class="card" id="profitForm">
  <div class="grid">
    <label class="col">
      <span>商品名</span>
      <input name="name" id="name" type="text" value="{{ request.args.get('name','') }}" placeholder="例：Nintendo Switch 有機EL">
    </label>

    <label class="col">
      <span>プラットフォーム</span>
      {% set pf_q = request.args.get('platform','') %}
      <select name="platform" id="platform">
        {% for opt in ['Amazon','楽天','ヤフショ','メルカリ','その他'] %}
          <option value="{{ opt }}" {% if pf_q==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="col">
      <span>販売価格（円）</span>
      <input name="price" id="price" type="number" inputmode="numeric" min="0" step="1" value="{{ request.args.get('price','') }}" required>
    </label>

    <label class="col">
      <span>仕入価格（円）</span>
      <input name="cost" id="cost" type="number" inputmode="numeric" min="0" step="1" value="{{ request.args.get('cost','') }}" required>
    </label>

    <label class="col">
      <span>送料（円）</span>
      <input name="ship" id="ship" type="number" inputmode="numeric" min="0" step="1" value="{{ request.args.get('ship','0') }}">
    </label>

    <div class="col">
      <span>手数料</span>
      <div class="fee-row">
        <select id="fee_mode" name="fee_mode">
          {% set fm = request.args.get('fee_mode','auto') %}
          <option value="auto" {% if fm=='auto' %}selected{% endif %}>自動（PF別ルール）</option>
          <option value="manual" {% if fm=='manual' %}selected{% endif %}>手動</option>
        </select>
        <input name="fee" id="fee" type="number" inputmode="numeric" min="0" step="1"
               value="{{ request.args.get('fee','') }}" placeholder="自動時は入力不要">
      </div>
      <small class="muted" id="fee_hint">PF別の推定レート：Amazon≒10%+100円 / 楽天≒7% / ヤフショ≒8% / メルカリ≒10% / その他≒5%</small>
    </div>
  </div>

  <div class="preview">
    <div class="pill">
      <div>推定手数料</div>
      <strong id="fee_auto_view">¥0</strong>
    </div>
    <div class="pill">
      <div>利益</div>
      <strong id="profit_view">¥0</strong>
    </div>
    <div class="pill">
      <div>利益率</div>
      <strong id="margin_view">0%</strong>
    </div>
  </div>

  <div class="actions">
    <button type="submit">保存（履歴へ）</button>
    <a class="secondary" href="{{ url_for('history') }}">履歴を見る</a>
  </div>
</form>

<style>
.card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:16px;margin:10px 0}
.grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.col{display:flex;flex-direction:column;gap:6px}
.col span{font-size:12px;color:#6b7280}
input,select{padding:8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
.fee-row{display:flex;gap:8px}
.muted{color:#6b7280}
.preview{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.pill{border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;background:#f8fafc;display:flex;gap:8px;align-items:center}
#profit_view.pos{color:#0a7f20} #profit_view.neg{color:#b91c1c}
.actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
button{padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#111;color:#fff;cursor:pointer}
a.secondary{padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;color:#111;text-decoration:none}
@media (max-width:720px){.grid{grid-template-columns:1fr}}
</style>

<script>
(() => {
  const $ = q => document.querySelector(q);
  const jpy = n => '¥' + (isFinite(n)? Math.round(n).toLocaleString() : '0');

  // 推定手数料（フロント側：サーバと同じルール）
  function estimateFee(platform, price){
    const p = String(platform||'').toLowerCase();
    const pr = parseFloat(price||0);
    if(!isFinite(pr) || pr<=0) return 0;

    if(p.includes('amazon') || p.includes('アマゾン')){
      return Math.round(pr * 0.10) + 100;         // 10% + 100円（簡易）
    }
    if(p.includes('楽天') || p.includes('rakuten')){
      return Math.round(pr * 0.07);               // 7%
    }
    if(p.includes('ヤフ') || p.includes('yahoo')){
      return Math.round(pr * 0.08);               // 8%
    }
    if(p.includes('メルカリ') || p.includes('mercari')){
      return Math.round(pr * 0.10);               // 10%
    }
    return Math.round(pr * 0.05);                 // その他 5%
  }

  function readNum(id){ return parseFloat($(id).value || 0) || 0; }

  function recalc(){
    const pf   = $('#platform').value;
    const price= readNum('#price');
    const cost = readNum('#cost');
    const ship = readNum('#ship');
    const mode = $('#fee_mode').value;

    let fee;
    if(mode==='auto'){
      fee = estimateFee(pf, price);
      $('#fee').value = fee;              // 送信用に反映
      $('#fee').setAttribute('readonly','readonly');
      $('#fee').style.opacity = 0.6;
    }else{
      fee = readNum('#fee');
      $('#fee').removeAttribute('readonly');
      $('#fee').style.opacity = 1;
    }

    // 表示
    $('#fee_auto_view').textContent = jpy(fee);

    const profit = Math.round(price - cost - ship - fee);
    const margin = price > 0 ? (profit / price * 100) : 0;

    const pv = $('#profit_view');
    pv.textContent = jpy(profit);
    pv.classList.toggle('pos', profit >= 0);
    pv.classList.toggle('neg', profit < 0);
    $('#margin_view').textContent = (isFinite(margin)? margin.toFixed(2) : '0') + '%';
  }

  ['#platform','#price','#cost','#ship','#fee','#fee_mode'].forEach(sel=>{
    $(sel).addEventListener('input', recalc);
    $(sel).addEventListener('change', recalc);
  });

  // 初期計算
  window.addEventListener('DOMContentLoaded', recalc);
})();
</script>
{% endblock %}
